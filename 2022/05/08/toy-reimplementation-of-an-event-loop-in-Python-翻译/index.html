<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="Mrli"><meta name="renderer" content="webkit"><meta name="copyright" content="Mrli"><meta name="keywords" content="Mrli's Blog"><meta name="description" content="æƒ³å’Œä½ è®²ï¼Œè¯´äº†ä¼šå¿ƒåŠ¨ ï¼Œç¼„é»˜ä¼šå¿ƒå®‰ã€‚"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>toy reimplementation of an event loop in Python[ç¿»è¯‘] Â· Mr.li's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="https://avatars1.githubusercontent.com/u/31088082?s=400&amp;u=7a99ff83916afb3f4c5312bd78a1be17fe0e34ed&amp;v=4"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Mrli</div><div class="profile-signature">åˆ«è£…ä½œå¾ˆåŠªåŠ›,<br>å› ä¸ºç»“å±€ä¸ä¼šé™ªä½ æ¼”æˆã€‚</div><div class="contacts"><div>Contacts:</div><span><a href="http://sighttp.qq.com/msgrd?v=1&amp;uin=1063052964" target="_black">QQ</a></span><span><a href="https://www.cnblogs.com/nymrli/" target="_black">åšå®¢å›­</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 60vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Mr.li's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">toy reimplementation of an event loop in Python[ç¿»è¯‘]</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-edit"></i><span>2022/05/09</span></span><span class="busuanzi-pv" id="busuanzi_container_page_pv"><i class="post-intro-calendar fa fa-user-o"></i><span id="busuanzi_value_page_pv"></span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="Python"> Python</a><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="ç¿»è¯‘"> ç¿»è¯‘</a><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="å¹¶å‘"> å¹¶å‘</a></span></div><div class="post-intro-read"><span> Word count: <span class="post-count">6,277</span> | Reading time: <span class="post-count">31</span>min</span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå°æ•…äº‹"><a class="markdownIt-Anchor" href="#äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå°æ•…äº‹"></a> äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå°æ•…äº‹</h1>
<blockquote>
<p>Translated from: <a href="https://github.com/AndreLouisCaron/a-tale-of-event-loops" target="_blank" rel="noopener">https://github.com/AndreLouisCaron/a-tale-of-event-loops</a></p>
</blockquote>
<p>æˆ‘æœ€è¿‘è¢«ä¼¯å…‹åˆ©å¤§å­¦çš„ç ”ç©¶å‘˜Nathaniel J. Smithå…³äº <a href="https://docs.python.org/3/library/asyncio.html" target="_blank" rel="noopener">asyncio</a> çš„æƒŠäººè§è§£æ‰€å›°ã€‚ä»–çš„æ–‡ç« ã€Šå…³äºåasync/awaitä¸–ç•Œä¸­å¼‚æ­¥APIè®¾è®¡çš„ä¸€äº›æƒ³æ³•ã€‹( <a href="https://vorpus.org/blog/some-thoughts-on-asynchronous-api-design-in-a-post-asyncawait-world/" target="_blank" rel="noopener">Some thoughts on asynchronous API design in a post-async/await world</a>) ä½¿å¾—æˆ‘ åœ¨æœ€è¿‘å¤§é‡ä½¿ç”¨asyncioåï¼Œå¯¹å®ƒæœ‰äº†ä¸€äº›ï¼ˆç•¥ï¼‰å¤æ‚çš„æ„Ÿå—ã€‚</p>
<p>è™½ç„¶è¿™æˆ–å¤šæˆ–å°‘æ˜¯ä»–æ–‡ç« çš„é‡ç‚¹ï¼Œä½†ä»–è®¤ä¸º <a href="https://github.com/dabeaz/curio" target="_blank" rel="noopener">curio</a> çš„å®ç°æ¯”asyncioç®€å•å¾—å¤šï¼Œå› ä¸ºå®ƒé¢„å…ˆå‡å®šä½ æœ‰ä¸€ä¸ªå®ç°<a href="https://www.python.org/dev/peps/pep-0492/" target="_blank" rel="noopener">PEP 492</a>ï¼ˆ<code>async</code>å’Œ<code>await</code>å…³é”®å­—ï¼‰çš„Pythonç‰ˆæœ¬ã€‚</p>
<p>æˆ‘å¾ˆæ„Ÿå…´è¶£ï¼Œçœ‹äº†ä¸€ä¸‹curioçš„æºä»£ç ï¼Œâ€¦ç”±äºå®ƒè·å¾—äº†å¾ˆå¤šåŠŸèƒ½ï¼ˆæœ‰å¸Œæœ›ä½¿å®ƒæ›´æ¥è¿‘äºä¸€ä¸ªå¯ç”Ÿäº§çš„åº“ï¼‰ï¼Œæˆ‘è®¤ä¸ºå®ƒç°åœ¨å·²ç»æ‹¥æœ‰è¶³å¤Ÿçš„åŠŸèƒ½ï¼Œä¸»è¦çš„æœ¬è´¨å·²ç»è¢«æ·¡åŒ–ã€‚è¿™ç»å¯¹ä¸æ˜¯ä¸€ä»¶åäº‹ï¼Œä½†å¦‚æœæ˜¯åƒæˆ‘ä¸€æ ·ï¼Œæƒ³äº†è§£Nathanielåœ¨è¯´ä»€ä¹ˆï¼Œå¹¶å­¦ä¹ ä¸€äº›æ•´æ´çš„PythonæŠ€å·§çš„è¯ï¼Œé˜…è¯»curioçš„æºä»£ç å‡ ä¹ä¸æ˜¯ä¸€ä¸ªå¥½çš„èµ·ç‚¹ã€‚</p>
<p>Pythonæ ¸å¿ƒå¼€å‘äººå‘˜Brett Cannonåœ¨ä»–çš„å¸–å­ã€Š<a href="http://www.snarky.ca/how-the-heck-does-async-await-work-in-python-3-5" target="_blank" rel="noopener">How the heck does async/await work in Python 3.5?</a>ã€‹ä¸­æä¾›äº†ä¸€äº›å…³äºå¦‚ä½•ä½¿ç”¨åç¨‹å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨å®ç°äº‹ä»¶å¾ªç¯ï¼‰éå¸¸å¥½çš„è§è§£ï¼Œä»–çš„é‡ç‚¹æ˜¯å®ç°ç»†èŠ‚ï¼Œè‡³å°‘å¯¹æˆ‘æ¥è¯´ï¼Œè¦æ‘¸æ¸…coroutineè¿˜æ˜¯ç¼ºå°‘ä¸€å°å—ã€‚</p>
<p>TL; DR: è¿™æ˜¯æˆ‘è¯•å›¾æŠ“ä½curioæ‰€åŸºäºçš„æ ¸å¿ƒåŸºæœ¬åŸç†çš„å°è¯•ã€‚å¸Œæœ›å®ƒèƒ½æˆä¸ºç†Ÿæ‚‰curioæºä»£ç çš„ä¸€ä¸ªå¥½çš„å«è„šçŸ³ã€‚</p>
<p>è®©æˆ‘ä»¬å¼€å§‹å§ ğŸ˜ƒ</p>
<h2 id="åç¨‹çš„æœ¬è´¨"><a class="markdownIt-Anchor" href="#åç¨‹çš„æœ¬è´¨"></a> åç¨‹çš„æœ¬è´¨</h2>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å½“è°ƒç”¨ä¸€ä¸ªåç¨‹æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<p><strong>æç¤º</strong>ï¼šä½ å¾—åˆ°ä¸€ä¸ª â€œcoroutineå¯¹è±¡â€ï¼Œå®ƒæœ‰ä¸€ä¸ª<code>.send()</code>å’Œä¸€ä¸ª<code>.throw()</code>æ–¹æ³•ï¼Œå°±åƒç”Ÿæˆå™¨å¯¹è±¡é‚£æ ·ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>coro = hello(<span class="string">'world'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(coro)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">coroutine</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">type</span><span class="params">(coro.send)</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">builtin_function_or_method</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">type</span><span class="params">(coro.throw)</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">builtin_function_or_method</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br><span class="line"><span class="class">...</span></span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œä½ é€šå¸¸ä¸ä¼šä½¿ç”¨è¿™äº›æ–¹æ³•ï¼Œå› ä¸ºå®ƒä»¬éšè—åœ¨<code>await coro</code>å’Œ<code>asyncio.get_event_loop().run_until_complete()</code>åé¢ï¼Œä½†æ—¢ç„¶æˆ‘ä»¬æƒ³ç ”ç©¶å®ƒçš„å·¥ä½œåŸç†â€¦ ğŸ˜ƒ</p>
<p>è¯·æ³¨æ„ï¼Œä¸Šé¢çš„ä»£ç ä»æ¥æ²¡æœ‰æ‰“å°è¿‡æˆ‘ä»¬çš„ <code>&quot;Hello, world!&quot;</code>ä¿¡æ¯ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä»æœªåœ¨coroutineå‡½æ•°ä¸­å®é™…æ‰§è¡Œè¿‡è¯­å¥â€”â€”æˆ‘ä»¬åªæ˜¯åˆ›å»ºäº†coroutineå¯¹è±¡ã€‚äº‹å®ä¸Šï¼Œå¦‚æœä½ åœ¨è§£é‡Šå™¨ä¸­å®é™…è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªè­¦å‘Šï¼Œè¯´æ˜æˆ‘ä»¬çš„hello coroutineä»æœªå®Œæˆã€‚</p>
<p>å¦‚æœä½ æƒ³æ‰§è¡Œcoroutineå‡½æ•°ï¼Œä½ éœ€è¦ä»¥æŸç§æ–¹å¼å®‰æ’å®ƒã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†è°ƒç”¨<code>.send()</code>æ–¹æ³•ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task = hello(<span class="string">'world'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>    task.send(<span class="keyword">None</span>)</span><br><span class="line"><span class="meta">... </span><span class="keyword">except</span> StopIteration:</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<p>å°±åƒç”Ÿæˆå™¨å¯¹è±¡ä¸€æ ·ï¼Œä¸€ä¸ªåç¨‹å¯¹è±¡çš„<code>.send()</code>æ–¹æ³•åœ¨åç¨‹ç»“æŸæ—¶å¼•å‘<code>StopIteration</code>äº‹ä»¶ã€‚</p>
<p>æˆ‘ä»¬å°†åœ¨åé¢çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨.send()æ–¹æ³•åœ¨ç¬¬äºŒæ¬¡ã€ç¬¬ä¸‰æ¬¡æˆ–ç¬¬Næ¬¡è°ƒç”¨<code>.send()</code>æ–¹æ³•é‡æ–°å¼€å§‹æ—¶å°†ä¿¡æ¯ä¼ é€’ç»™coroutineã€‚</p>
<p>å¦‚æœè¯¥å¾ªç¯ç¨‹åºæ²¡æœ‰æ­£å¸¸è¿”å›ï¼Œè€Œæ˜¯å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥å¼‚å¸¸å°†é€šè¿‡<code>.send()</code>ä¼ æ’­å›æ¥ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">HelloException</span><span class="params">(Exception)</span>:</span></span><br><span class="line"><span class="meta">... </span>   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>       self._name = name</span><br><span class="line"><span class="meta">... </span>   <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>       <span class="keyword">return</span> <span class="string">'Hello, %s!'</span> % (self._name,)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">raise</span> HelloException(name)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task = hello(<span class="string">'world'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>    task.send(<span class="keyword">None</span>)</span><br><span class="line"><span class="meta">... </span><span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: exception will be propagated here!</span></span><br><span class="line"><span class="meta">... </span>    print(error)</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<p>æˆ‘è¿˜æåˆ°äº†ä¸€ä¸ª<code>.throw()</code>æ–¹æ³•ã€‚å’Œ<code>.send()</code>ä¸€æ ·ï¼Œå®ƒæ¢å¤äº†åç¨‹ï¼Œä½†å®ƒä¸æ˜¯ä¼ é€’ä¸€ä¸ªå€¼ï¼Œè€Œæ˜¯åœ¨åç¨‹ä¸­çš„æš‚åœç‚¹å¼•å‘ä¸€ä¸ªå¼‚å¸¸ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Hello</span><span class="params">(Exception)</span>:</span></span><br><span class="line"><span class="meta">... </span>   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line"><span class="meta">... </span>       self._name = name</span><br><span class="line"><span class="meta">... </span>   <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>       <span class="keyword">return</span> <span class="string">'Hello, %s!'</span> % (self._name,)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task = hello()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: inject exception.</span></span><br><span class="line"><span class="meta">... </span>    task.throw(Hello(<span class="string">'world'</span>))</span><br><span class="line"><span class="meta">... </span><span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line"><span class="meta">... </span>    print(error)</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä½ åº”è¯¥å¯¹è¿™æ ·ä¸€ä¸ªäº‹å®æ„Ÿåˆ°æ»¡æ„ï¼šcoroutine å¯¹è±¡ä¸ç”Ÿæˆå™¨å¯¹è±¡éå¸¸éå¸¸ç›¸ä¼¼ï¼Œåè€…ä» Python 2.2 (<a href="https://www.python.org/dev/peps/pep-0255/" target="_blank" rel="noopener">PEP 255</a>) å¼€å§‹å°±å­˜åœ¨ï¼Œå¹¶ä¸”ä» Python 2.5 (<a href="https://www.python.org/dev/peps/pep-0342/" target="_blank" rel="noopener">PEP 342</a>) å¼€å§‹å°±æœ‰ <code>.send()</code>å’Œ <code>.throw()</code>æ–¹æ³•ã€‚</p>
<h2 id="ä¸äº‹ä»¶å¾ªç¯çš„å¯¹è¯"><a class="markdownIt-Anchor" href="#ä¸äº‹ä»¶å¾ªç¯çš„å¯¹è¯"></a> ä¸äº‹ä»¶å¾ªç¯çš„å¯¹è¯</h2>
<p>å¦‚æœä½ ä»”ç»†è§‚å¯Ÿï¼ˆæˆ–å°è¯•ï¼‰ï¼Œä½ ä¼šå‘ç°ï¼Œä¸ç”Ÿæˆå™¨å‡½æ•°ç›¸åï¼Œcoroutineå‡½æ•°ä¸èƒ½ä½¿ç”¨<code>yield</code>è¡¨è¾¾å¼ã€‚è¿™å°±æå‡ºäº†ï¼ˆè€Œä¸æ˜¯ <a href="http://grammarist.com/usage/begging-the-question-usage/" target="_blank" rel="noopener">begs</a>ï¼‰ä¸€ä¸ªé—®é¢˜ï¼šåˆ°åº•æ€æ ·æ‰èƒ½è®©coroutineå‡½æ•°å°†æ§åˆ¶æƒäº¤è¿˜ç»™è°ƒç”¨<code>.send()</code>çš„ä»£ç ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯åœ¨ä¸€ä¸ª<em>awaitalbe</em>å¯¹è±¡ä¸Šä½¿ç”¨<code>await</code>ã€‚å¯¹äºä¸€ä¸ªå¯¹è±¡æ¥è¯´ï¼Œå®ƒå¿…é¡»å®ç°ç‰¹æ®Šçš„<code>__await__()</code>æ–¹æ³•ï¼Œä»¥è¿”å›ä¸€ä¸ªiterableå¯¹è±¡ã€‚åœ¨å®è·µä¸­ï¼Œè¿™æœ‰ç‚¹å°´å°¬ï¼Œæ‰€ä»¥åœ¨æ ‡å‡†åº“ä¸­æœ‰ä¸€ä¸ª<code>@types.coroutine</code>è£…é¥°å™¨ï¼Œå…è®¸ä½ ä»¥ä¸€ç§ç±»ä¼¼<code>@contextlib.contextmanager</code>çš„é£æ ¼æ¥åˆ›å»ºawaitableå¯¹è±¡ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: this is an awaitable object!</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">nice</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: this makes ``.send()`` return!</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> nice()</span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task = hello(<span class="string">'world'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: call send twice!</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task.send(<span class="keyword">None</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>    task.send(<span class="keyword">None</span>)</span><br><span class="line"><span class="meta">... </span><span class="keyword">except</span> StopIteration:</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬çš„<code>nice()</code>å¯¹è±¡æ˜¯éå¸¸æ— ç”¨çš„ã€‚åˆ«ç€æ€¥ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šåšä¸€äº›æ›´æœ‰ç”¨çš„äº‹æƒ…ã€‚</p>
<h2 id="looping"><a class="markdownIt-Anchor" href="#looping"></a> Looping</h2>
<p>æˆ‘ä»¬å‰é¢çš„ä¾‹å­æ­£å¥½è°ƒç”¨<code>.send()</code>ä¸¤æ¬¡ï¼Œå› ä¸ºå®ƒçŸ¥é“<code>hello()</code>åªäº§ç”Ÿä¸€æ¬¡æ§åˆ¶ã€‚å½“æˆ‘ä»¬ä¸çŸ¥é“æ—¶ï¼ˆå¸¸è§çš„æƒ…å†µï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒæ”¾åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">nice</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: yield many times!</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">await</span> nice()</span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>task = hello(<span class="string">'world'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: loop!</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line"><span class="meta">... </span>        task.send(<span class="keyword">None</span>)</span><br><span class="line"><span class="meta">... </span><span class="keyword">except</span> StopIteration:</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é€æ¸å¼€å§‹å¾—åˆ°äº†ä¸€äº›æœ€ç®€å•çš„å®ç°ï¼Œå…¶ç±»ä¼¼äº<code>asyncio.get_event_loop().run_until_complete()</code>ã€‚æ‰€ä»¥æˆ‘ä»¬è®©å®ƒåœ¨è¯­æ³•ä¸Šæ›´åŠ ç›¸ä¼¼ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">nice</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">await</span> nice()</span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: now a reusable function!</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line"><span class="meta">... </span>            task.send(<span class="keyword">None</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">except</span> StopIteration:</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">pass</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: call it as a function!</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>run_until_complete(hello(<span class="string">'world'</span>))</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<h2 id="ç”Ÿæˆå­ä»»åŠ¡"><a class="markdownIt-Anchor" href="#ç”Ÿæˆå­ä»»åŠ¡"></a> ç”Ÿæˆå­ä»»åŠ¡</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªå¯ä»¥å®Œæˆå•ä¸ªä»»åŠ¡çš„äº‹ä»¶å¾ªç¯ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³å¼€å§‹åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ã€‚æˆ‘ä»¬æœŸæœ›åšè®¸å¤šä¸åŒçš„äº‹æƒ…ï¼Œä½†ç”±äºè¿™æ˜¯å…³äºå¹¶å‘çš„ï¼Œè®©æˆ‘ä»¬ä»å…è®¸åˆ›å»ºå­ä»»åŠ¡å¼€å§‹ã€‚</p>
<p>æˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦åšçš„ä¸»è¦äº‹æƒ…æ˜¯å¼•å…¥ä¸€ä¸ªæ–°çš„åŸè¯­<code>spawn()</code>ï¼Œç”¨äºå®‰æ’æ–°çš„å­ä»»åŠ¡ã€‚ä¸€æ—¦ä»»åŠ¡è¢«å®‰æ’å¥½ï¼Œæˆ‘ä»¬è¦æŠŠæ§åˆ¶æƒè¿”å›ç»™çˆ¶ä»»åŠ¡ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥ç»§ç»­å‰è¿›äº†ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šè¿™ä¸ªä¾‹å­æ˜¯æ•…æ„ä¸å®Œæ•´çš„ã€‚æˆ‘ä»¬ä»¥åä¼šçœ‹åˆ°å¦‚ä½•joinä»»åŠ¡ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> inspect <span class="keyword">import</span> iscoroutine</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: awaitable object that sends a request to launch a child task!</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">spawn</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span> task</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> nice()</span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: parent task!</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>     <span class="comment"># NEW: create a child task!</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> spawn(hello(<span class="string">'world'</span>))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: schedule the "root" task.</span></span><br><span class="line"><span class="meta">... </span>    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> tasks:</span><br><span class="line"><span class="meta">... </span>        <span class="comment"># NEW: round-robin between a set tasks (we may now have more</span></span><br><span class="line"><span class="meta">... </span>        <span class="comment">#      than one and we'd like to be as "fair" as possible).</span></span><br><span class="line"><span class="meta">... </span>        queue, tasks = tasks, []</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line"><span class="meta">... </span>            <span class="comment"># NEW: resume the task *once*.</span></span><br><span class="line"><span class="meta">... </span>            <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>                data = task.send(data)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">except</span> StopIteration:</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span>            <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: prevent crashed task from ending the loop.</span></span><br><span class="line"><span class="meta">... </span>                print(error)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: schedule the child task.</span></span><br><span class="line"><span class="meta">... </span>                <span class="keyword">if</span> iscoroutine(data):</span><br><span class="line"><span class="meta">... </span>                    tasks.append((data, <span class="keyword">None</span>))</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: reschedule the parent task.</span></span><br><span class="line"><span class="meta">... </span>                tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>run_until_complete(main())</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<p><strong>å“‡</strong>! è¿™æ¯”æˆ‘ä»¬ä¹‹å‰ç‰ˆæœ¬çš„<code>run_until_complete()</code>è¦å¤æ‚å¾—å¤šã€‚è¿™äº›éƒ½æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ</p>
<p>å¥½å§â€¦ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œå¤šä¸ªä»»åŠ¡äº†ï¼Œæˆ‘ä»¬éœ€è¦æ‹…å¿ƒçš„äº‹æƒ…åŒ…æ‹¬:</p>
<ol>
<li>ç­‰å¾…æ‰€æœ‰çš„å­ä»»åŠ¡å®Œæˆï¼ˆé€’å½’ï¼‰ï¼Œå°½ç®¡ä»»ä½•ä»»åŠ¡éƒ½æœ‰é”™è¯¯</li>
<li>åœ¨ä»»åŠ¡ä¹‹é—´äº¤æ›¿è¿›è¡Œï¼Œè®©æ‰€æœ‰çš„ä»»åŠ¡åŒæ—¶å®Œæˆ</li>
</ol>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªåµŒå¥—å¾ªç¯ã€‚</p>
<ul>
<li>å¤–å¾ªç¯è´Ÿè´£æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å®Œæˆäº†ä»»åŠ¡</li>
<li>å†…å¾ªç¯è´Ÿè´£å¤„ç†ä¸€æ¬¡è°ƒåº¦å™¨çš„ â€œtickâ€ï¼ˆå€’è®¡æ—¶å®Œæˆï¼‰ã€‚</li>
</ul>
<p>è¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œè€Œä¸”æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå¯èƒ½ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œä½†è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºäº‹ä»¶å¾ªç¯ä¸­è¿˜ç¼ºå°‘ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ï¼šå®šæ—¶å™¨å’ŒI/Oã€‚å½“æˆ‘ä»¬ä»¥åå¢åŠ å¯¹è¿™äº›çš„æ”¯æŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä»¥ä¸€ç§ &quot;å…¬å¹³ &quot;çš„æ–¹å¼æ¥å®‰æ’å†…éƒ¨æ£€æŸ¥ã€‚å¤–å¾ªç¯ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ£€æŸ¥è®¡æ—¶å™¨å’Œè½®è¯¢I/Oæ“ä½œçŠ¶æ€çš„æ–¹ä¾¿ä½ç½®ã€‚</p>
<ol>
<li>æ£€æŸ¥å®šæ—¶å™¨ï¼Œæ¢å¤å·²ç»è¿‡äº†å»¶è¿ŸæœŸçš„ç¡çœ ä»»åŠ¡ã€‚</li>
<li>æ£€æŸ¥I/Oæ“ä½œï¼Œå®‰æ’é‚£äº›å¾…å®šI/Oæ“ä½œå·²ç»å®Œæˆçš„ä»»åŠ¡ã€‚</li>
<li>æ‰§è¡Œä¸€æ¬¡è°ƒåº¦å™¨çš„&quot;tick&quot;ï¼Œä»¥æ¢å¤æˆ‘ä»¬åˆšåˆšè°ƒåº¦çš„æ‰€æœ‰ä»»åŠ¡ã€‚</li>
</ol>
<p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™å°±æ˜¯åŸºäºcoroutineçš„è°ƒåº¦å™¨å¾ªç¯çš„è¦ç‚¹ã€‚</p>
<p><strong>ç„¶è€Œ</strong>ï¼Œåœ¨æˆ‘ä»¬è¿›å…¥æ›´å¤æ‚çš„å®šæ—¶å™¨å’ŒI/Oä¹‹å‰â€¦è¿˜è®°å¾—æˆ‘åœ¨å‰é¢æåˆ°è¿™ä¸ªä¾‹å­æ˜¯æ•…æ„ä¸å®Œæ•´çš„å—ï¼Ÿæˆ‘ä»¬çŸ¥é“å¦‚ä½•ç”Ÿæˆæ–°çš„å­ä»»åŠ¡ï¼Œä½†æˆ‘ä»¬è¿˜ä¸çŸ¥é“å¦‚ä½•ç­‰å¾…å®ƒä»¬å®Œæˆã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æœºä¼šæ¥å­¦ä¹ å¦‚ä½•æ‰©å±•ï¼Œç”±æˆ‘ä»¬çš„awaitableå¯¹è±¡å‘é€äº‹ä»¶å¾ªç¯ &quot;è¯·æ±‚&quot;çš„è¯æ±‡è¡¨ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">nice</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">spawn</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: recover the child task handle to pass it back to the parent.</span></span><br><span class="line"><span class="meta">... </span>    child = <span class="keyword">yield</span> (<span class="string">'spawn'</span>, task)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> child</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: awaitable object that sends a request to be notified when a</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment">#      concurrent task completes.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">join</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span> (<span class="string">'join'</span>, task)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> nice()</span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: recover the child task handle.</span></span><br><span class="line"><span class="meta">... </span>    child = <span class="keyword">await</span> spawn(hello(<span class="string">'world'</span>))</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: wait for the child task to complete.</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> join(child)</span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'(after join)'</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: keep track of tasks to resume when a task completes.</span></span><br><span class="line"><span class="meta">... </span>    watch = defaultdict(list)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> tasks:</span><br><span class="line"><span class="meta">... </span>        queue, tasks = tasks, []</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>                data = task.send(data)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">except</span> StopIteration:</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: wait up tasks waiting on this one.</span></span><br><span class="line"><span class="meta">... </span>                tasks.extend((t, <span class="keyword">None</span>) <span class="keyword">for</span> t <span class="keyword">in</span> watch.pop(task, []))</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: dispatch request sent by awaitable object since</span></span><br><span class="line"><span class="meta">... </span>                <span class="comment">#      we now have 3 different types of requests.</span></span><br><span class="line"><span class="meta">... </span>                <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'spawn'</span>:</span><br><span class="line"><span class="meta">... </span>                    tasks.append((data[<span class="number">1</span>], <span class="keyword">None</span>))</span><br><span class="line"><span class="meta">... </span>                    tasks.append((task, data[<span class="number">1</span>]))</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">elif</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'join'</span>:</span><br><span class="line"><span class="meta">... </span>                    watch[data[<span class="number">1</span>]].append(task)</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                    tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>run_until_complete(main())</span><br><span class="line">Hello, world!</span><br><span class="line">(after join)</span><br></pre></td></tr></table></figure>
<p>ç”±äºå®é™…åŸå› ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›æœ‰æŸç§TaskåŒ…è£…å™¨ç”¨äºcoroutineå¯¹è±¡ã€‚è¿™å¯¹äºæš´éœ²cancleçš„APIå’Œå¤„ç†ä¸€äº›ç«äº‰æƒ…å†µæ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œæ¯”å¦‚å­ä»»åŠ¡åœ¨çˆ¶ä»»åŠ¡è¯•å›¾<code>join()</code>å®ƒä¹‹å‰å°±ç»“æŸäº†ï¼ˆä½ èƒ½å‘ç°è¿™ä¸ªbugå—ï¼Ÿï¼‰</p>
<p>å°†å­ä»»åŠ¡çš„è¿”å›å€¼ä½œä¸º<code>await join()</code> çš„ç»“æœä¼ å›ï¼Œå¹¶ä¼ æ’­ä½¿å­ä»»åŠ¡å´©æºƒçš„å¼‚å¸¸ï¼Œè¿™äº›éƒ½æ˜¯ç•™ç»™è¯»è€…çš„ç»ƒä¹ ã€‚</p>
<h2 id="sleeping-timers"><a class="markdownIt-Anchor" href="#sleeping-timers"></a> Sleeping &amp; timers</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»æ§åˆ¶äº†ä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å¤„ç†ä¸€äº›æ›´é«˜çº§çš„ä¸œè¥¿ï¼Œæ¯”å¦‚å®šæ—¶å™¨å’ŒI/Oã€‚I/Oæ˜¯æœ€ç»ˆçš„ç›®æ ‡ï¼Œä½†å®ƒç‰µæ¶‰åˆ°å¾ˆå¤šæ–°çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹çœ‹å®šæ—¶å™¨ã€‚</p>
<p>å¦‚æœä½ éœ€è¦ä¼‘çœ Sleepï¼Œä½ ä¸èƒ½åªè°ƒç”¨<code>time.sleep()</code>ï¼Œå› ä¸ºä½ ä¼šé˜»å¡æ‰€æœ‰çš„ä»»åŠ¡ï¼Œè€Œä¸ä»…ä»…æ˜¯ä½ æƒ³æš‚åœçš„é‚£ä¸ªã€‚</p>
<p>ä½ ç°åœ¨å¯èƒ½å·²ç»å‘ç°äº†è¿™ä¸ªæ¨¡å¼ã€‚æˆ‘ä»¬å°†æ·»åŠ ä¸¤æ ·ä¸œè¥¿ã€‚</p>
<ol>
<li>ä¸€ç§æ–°çš„è¯·æ±‚ç±»å‹</li>
<li>ä¸€æ®µåŸºäº<code>task.send()</code>è¿”å›å€¼çš„è°ƒåº¦ä»£ç ã€‚</li>
</ol>
<p>æˆ‘ä»¬è¿˜å°†æ·»åŠ ä¸€äº›bookKeepingä»¥è·Ÿè¸ªé‚£äº›è¢«æš‚åœçš„ä»»åŠ¡ã€‚è¯·è®°ä½ï¼Œtasksæ˜¯ä¸€ä¸ªé¢„å®šåœ¨ä¸‹ä¸€ä¸ªtickä¸­è¿è¡Œçš„coroutineåˆ—è¡¨ï¼Œä½†æ²‰ç¡çš„ä»»åŠ¡åœ¨å‡†å¤‡å†æ¬¡è¿è¡Œä¹‹å‰å¯èƒ½ä¼šè·³è¿‡ä¸€ä¸ªæˆ–å¤šä¸ªtickã€‚</p>
<p>è¯·è®°ä½ï¼Œä¼‘çœ çš„ä»»åŠ¡ä¸å¤ªå¯èƒ½æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºé‡æ–°å®‰æ’ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€äº›æ›´è¿›åŒ–çš„ä¸œè¥¿ã€‚ç»´æŠ¤è®¡æ—¶å™¨ï¼Œæœ€å®ç”¨çš„æ–¹æ³•ï¼ˆç›´åˆ°ä½ å…è®¸å–æ¶ˆå®ƒä»¬ï¼‰æ˜¯ä½¿ç”¨ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ„Ÿè°¢æ ‡å‡†åº“çš„ <a href="https://docs.python.org/3.5/library/heapq.html" target="_blank" rel="noopener">heapq</a> æ¨¡å—ä½¿ä¹‹è¶…çº§ç®€å•ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> heapq <span class="keyword">import</span> heappop, heappush</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> time <span class="keyword">import</span> sleep <span class="keyword">as</span> _sleep</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> timeit <span class="keyword">import</span> default_timer</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: we need to keep track of elapsed time.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>clock = default_timer</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: request that the event loop reschedule us "later".</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(seconds)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span> (<span class="string">'sleep'</span>, seconds)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: verify elapsed time matches our request.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    ref = clock()</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> sleep(<span class="number">3.0</span>)</span><br><span class="line"><span class="meta">... </span>    now = clock()</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">assert</span> (now - ref) &gt;= <span class="number">3.0</span></span><br><span class="line"><span class="meta">... </span>    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: keep track of tasks that are sleeping.</span></span><br><span class="line"><span class="meta">... </span>    timers = []</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: watch out, all tasks might be suspended at the same time.</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> tasks <span class="keyword">or</span> timers:</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>        <span class="comment"># NEW: if we have nothing to do for now, don't spin.</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> <span class="keyword">not</span> tasks:</span><br><span class="line"><span class="meta">... </span>            _sleep(max(<span class="number">0.0</span>, timers[<span class="number">0</span>][<span class="number">0</span>] - clock()))</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>        <span class="comment"># NEW: schedule tasks when their timer has elapsed.</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">while</span> timers <span class="keyword">and</span> timers[<span class="number">0</span>][<span class="number">0</span>] &lt; clock():</span><br><span class="line"><span class="meta">... </span>            _, task = heappop(timers)</span><br><span class="line"><span class="meta">... </span>            tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>        queue, tasks = tasks, []</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>                data = task.send(data)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">except</span> StopIteration:</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span>            <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: set a timer and don't reschedule right away.</span></span><br><span class="line"><span class="meta">... </span>                <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'sleep'</span>:</span><br><span class="line"><span class="meta">... </span>                    heappush(timers, (clock() + data[<span class="number">1</span>], task))</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                    tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>run_until_complete(hello(<span class="string">'world'</span>))</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<p>å“‡ï¼Œæˆ‘ä»¬çœŸçš„æŒæ¡äº†è¿™ä¸ªçªé—¨! ä¹Ÿè®¸è¿™ä¸ªå¼‚æ­¥çš„ä¸œè¥¿æ¯•ç«Ÿæ²¡æœ‰é‚£ä¹ˆéš¾ï¼Ÿ</p>
<p>è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬èƒ½ä¸ºI/Oåšä»€ä¹ˆ!</p>
<h2 id="å¤„ç†io"><a class="markdownIt-Anchor" href="#å¤„ç†io"></a> å¤„ç†I/O</h2>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»ç»å†äº†æ‰€æœ‰å…¶ä»–çš„äº‹æƒ…ï¼Œæ˜¯æ—¶å€™è¿›è¡Œç»ˆæå¯¹å†³äº†ï¼šI/Oã€‚</p>
<p>å¯ä¼¸ç¼©çš„ I/O é€šå¸¸ä½¿ç”¨native Cçš„APIs æ¥å®ç° I/O çš„å¤ç”¨ã€‚é€šå¸¸ï¼Œè¿™æ˜¯ I/O åº“ä¸­æœ€å›°éš¾çš„éƒ¨åˆ†ï¼Œä½†å€¼å¾—åº†å¹¸çš„æ˜¯ï¼ŒPython çš„ <a href="https://docs.python.org/3/library/selectors.html" target="_blank" rel="noopener">selectors</a> æ¨¡å—ä½¿å…¶éå¸¸å®¹æ˜“å®ç°ã€‚</p>
<p>è‡³äºåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬æ·»åŠ çš„æ‰€æœ‰å…¶ä»–æ“ä½œï¼Œæˆ‘ä»¬å°†åœ¨äº‹ä»¶å¾ªç¯ä¸­æ·»åŠ ä¸€äº›æ–°çš„I/Oè¯·æ±‚å’Œç›¸åº”çš„è¯·æ±‚å¤„ç†ç¨‹åºã€‚å¦å¤–ï¼Œåƒè®¡æ—¶å™¨ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªè°ƒåº¦å™¨çš„å¼€å§‹é˜¶æ®µåšä¸€äº›å†…éƒ¨æ£€æŸ¥ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> selectors <span class="keyword">import</span> (</span><br><span class="line"><span class="meta">... </span>    DefaultSelector,</span><br><span class="line"><span class="meta">... </span>    EVENT_READ,</span><br><span class="line"><span class="meta">... </span>    EVENT_WRITE,</span><br><span class="line"><span class="meta">... </span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> socket <span class="keyword">import</span> socketpair <span class="keyword">as</span> _socketpair</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: request that the event loop tell us when we can read.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(stream, size)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span> (EVENT_READ, stream)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> stream.recv(size)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: request that the event loop tell us when we can write.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(stream, data)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> data:</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">yield</span> (EVENT_WRITE, stream)</span><br><span class="line"><span class="meta">... </span>        size = stream.send(data)</span><br><span class="line"><span class="meta">... </span>        data = data[size:]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: connect sockets, make sure they never, ever block the loop.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">socketpair</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    lhs, rhs = _socketpair()</span><br><span class="line"><span class="meta">... </span>    lhs.setblocking(<span class="keyword">False</span>)</span><br><span class="line"><span class="meta">... </span>    rhs.setblocking(<span class="keyword">False</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> lhs, rhs</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: send a message through the socket pair.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    lhs, rhs = <span class="keyword">await</span> socketpair()</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> send(lhs, <span class="string">'Hello, world!'</span>.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="meta">... </span>    data = <span class="keyword">await</span> recv(rhs, <span class="number">1024</span>)</span><br><span class="line"><span class="meta">... </span>    print(data.decode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="meta">... </span>    lhs.close()</span><br><span class="line"><span class="meta">... </span>    rhs.close()</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: prepare for I/O multiplexing.</span></span><br><span class="line"><span class="meta">... </span>    selector = DefaultSelector()</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: watch out, all tasks might be suspended at the same time.</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> tasks <span class="keyword">or</span> selector.get_map():</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>        <span class="comment"># NEW: poll I/O operation status and resume tasks when ready.</span></span><br><span class="line"><span class="meta">... </span>        timeout = <span class="number">0.0</span> <span class="keyword">if</span> tasks <span class="keyword">else</span> <span class="keyword">None</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">for</span> key, events <span class="keyword">in</span> selector.select(timeout):</span><br><span class="line"><span class="meta">... </span>            tasks.append((key.data, <span class="keyword">None</span>))</span><br><span class="line"><span class="meta">... </span>            selector.unregister(key.fileobj)</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>        queue, tasks = tasks, []</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>                data = task.send(data)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">except</span> StopIteration:</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span>            <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: register for I/O and suspend the task.</span></span><br><span class="line"><span class="meta">... </span>                <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == EVENT_READ:</span><br><span class="line"><span class="meta">... </span>                    selector.register(data[<span class="number">1</span>], EVENT_READ, task)</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">elif</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == EVENT_WRITE:</span><br><span class="line"><span class="meta">... </span>                    selector.register(data[<span class="number">1</span>], EVENT_WRITE, task)</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                    tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>run_until_complete(hello(<span class="string">'world'</span>))</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<h2 id="å–æ¶ˆä»»åŠ¡"><a class="markdownIt-Anchor" href="#å–æ¶ˆä»»åŠ¡"></a> å–æ¶ˆä»»åŠ¡</h2>
<p>æœ€åï¼Œä½†ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€å—æ‹¼å›¾æ˜¯â€”â€”å–æ¶ˆä»»åŠ¡ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åˆ©ç”¨coroutineå¯¹è±¡çš„<code>.throw()</code>æ–¹æ³•çš„åœ°æ–¹ã€‚</p>
<p>ç”±äºå–æ¶ˆä»»åŠ¡æœ‰ä¸€ä¸ªç«äº‰æ¡ä»¶ï¼ˆå®ƒå¯èƒ½ä¸å°è¯•å–æ¶ˆä»»åŠ¡åŒæ—¶å®Œæˆï¼‰ï¼Œæ‰€ä»¥éœ€è¦è·Ÿè¸ªæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œä»¥äº†è§£å®ƒä»¬çš„ â€œçŠ¶æ€â€ã€‚</p>
<p>å¦åˆ™ï¼Œå®ƒå°±æ˜¯ä»»åŠ¡ç”Ÿæˆå’ŒåŠ å…¥çš„ç®€å•æ‰©å±•ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šè¿™ä¸ªå®ç°æ˜¯æ•…æ„ä¸å®Œæ•´çš„ã€‚å®ƒæ²¡æœ‰æ­£ç¡®å¤„ç†å–æ¶ˆä¸€ä¸ªå·²ç»å®‰æ’åœ¨ä¸‹ä¸€ä¸ªtickä¸­è¿è¡Œçš„ä»»åŠ¡çš„å¯èƒ½æ€§ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> inspect <span class="keyword">import</span> iscoroutine</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">spawn</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    task = <span class="keyword">yield</span> (<span class="string">'spawn'</span>, task)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> task</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">join</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span> (<span class="string">'join'</span>, task)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: exception to be raised inside tasks when they are cancelled.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">CancelledError</span><span class="params">(Exception)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: request that CancelledError be raised inside the task.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">cancel</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    cancelled = <span class="keyword">yield</span> (<span class="string">'cancel'</span>, task, CancelledError())</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">assert</span> cancelled <span class="keyword">is</span> <span class="keyword">True</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: pause the task without plans to reschedule it (this is simply to</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment">#      guarantee execution order in this demo).</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>@coroutine</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">suspend</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">yield</span> (<span class="string">'suspend'</span>,)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">await</span> suspend()</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">except</span> CancelledError:</span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># NEW: spawn a task and then cancel it.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    child = <span class="keyword">await</span> spawn(hello(<span class="string">'world'</span>))</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> cancel(child)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">await</span> join(child)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line"><span class="meta">... </span>    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line"><span class="meta">... </span>    watch = defaultdict(list)</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># NEW: keep track of all tasks in the tree.</span></span><br><span class="line"><span class="meta">... </span>    tree = &#123;task&#125;</span><br><span class="line">...</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> tasks:</span><br><span class="line"><span class="meta">... </span>        queue, tasks = tasks, []</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: we may need to pass data or inject an exception.</span></span><br><span class="line"><span class="meta">... </span>                <span class="keyword">if</span> isinstance(data, Exception):</span><br><span class="line"><span class="meta">... </span>                    data = task.throw(data)</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                    data = task.send(data)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">except</span> (StopIteration, CancelledError):</span><br><span class="line"><span class="meta">... </span>                tasks.extend((t, <span class="keyword">None</span>) <span class="keyword">for</span> t <span class="keyword">in</span> watch.pop(task, []))</span><br><span class="line"><span class="meta">... </span>                <span class="comment"># NEW: update bookkeeping.</span></span><br><span class="line"><span class="meta">... </span>                tree.discard(task)</span><br><span class="line"><span class="meta">... </span>            <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'spawn'</span>:</span><br><span class="line"><span class="meta">... </span>                    tasks.append((data[<span class="number">1</span>], <span class="keyword">None</span>))</span><br><span class="line"><span class="meta">... </span>                    tasks.append((task, data[<span class="number">1</span>]))</span><br><span class="line"><span class="meta">... </span>                    <span class="comment"># NEW: update bookkeeping.</span></span><br><span class="line"><span class="meta">... </span>                    tree.add(data[<span class="number">1</span>])</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">elif</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'join'</span>:</span><br><span class="line"><span class="meta">... </span>                    watch[data[<span class="number">1</span>]].append(task)</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">elif</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'cancel'</span>:</span><br><span class="line"><span class="meta">... </span>                    <span class="comment"># NEW: schedule to raise the exception in the task.</span></span><br><span class="line"><span class="meta">... </span>                    <span class="keyword">if</span> data[<span class="number">1</span>] <span class="keyword">in</span> tree:</span><br><span class="line"><span class="meta">... </span>                        tasks.append((data[<span class="number">1</span>], data[<span class="number">2</span>]))</span><br><span class="line"><span class="meta">... </span>                        tasks.append((task, <span class="keyword">True</span>))</span><br><span class="line"><span class="meta">... </span>                    <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                        tasks.append((task, <span class="keyword">False</span>))</span><br><span class="line"><span class="meta">... </span>                <span class="keyword">elif</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'suspend'</span>:</span><br><span class="line"><span class="meta">... </span>                    <span class="keyword">pass</span></span><br><span class="line"><span class="meta">... </span>                <span class="keyword">else</span>:</span><br><span class="line"><span class="meta">... </span>                    tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>run_until_complete(main())</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure>
<h2 id="è®¸å¯è¯"><a class="markdownIt-Anchor" href="#è®¸å¯è¯"></a> è®¸å¯è¯</h2>
<p>æœ¬æ–‡ä»¶çš„ç‰ˆæƒå½’Andre Caron <a href="mailto:andre.l.caron@gmail.com" target="_blank" rel="noopener">andre.l.caron@gmail.com</a>æ‰€æœ‰ï¼Œå¹¶åœ¨çŸ¥è¯†å…±äº« <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode" target="_blank" rel="noopener">CC-BY-SA</a>  è®¸å¯ä¸‹å‘æ‚¨æä¾›ã€‚</p>
<h1 id="ä¸ªäººæ”¶è·"><a class="markdownIt-Anchor" href="#ä¸ªäººæ”¶è·"></a> ä¸ªäººæ”¶è·</h1>
<p>ä¸€ä¸ªå¼‚æ­¥æ¡†æ¶é€šå¸¸ä¸»è¦åŒ…æ‹¬äº‹ä»¶å¾ªç¯ã€<a href="https://www.zhihu.com/search?q=%E4%BA%8B%E4%BB%B6%E9%98%9F%E5%88%97&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A555273313%7D" target="_blank" rel="noopener">äº‹ä»¶é˜Ÿåˆ—</a>ã€pollingã€timeré˜Ÿåˆ—ï¼Œæ‰€æœ‰çš„å¼‚æ­¥æ¡†æ¶çš†ä¸ä¾‹å¤–ï¼Œasyncioä¹Ÿæ˜¯å¦‚æ­¤ã€‚æœ¬æ–‡çš„toy event loopä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåœ¨è‡ªå·±å®ç°çš„æ—¶å€™å°±æ˜¯å…³æ³¨è¿™å‡ ä¸ªéƒ¨åˆ†ã€‚</p>
<p>æ–‡ä¸­çš„å®éªŒéƒ½è¡¨æ˜äº†ï¼Œåç¨‹çš„<code>send()</code>ã€<code>throw()</code>ã€<code>await</code>ä¸<code>send()</code>ã€<code>throw()</code>ã€<code>yield</code>ä½¿ç”¨éƒ½ç±»ä¼¼ã€‚</p>
<h1 id="ä¸ªäººå®éªŒ"><a class="markdownIt-Anchor" href="#ä¸ªäººå®éªŒ"></a> ä¸ªäººå®éªŒ</h1>
<p>é’ˆå¯¹<a href="#%E4%B8%8E%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E7%9A%84%E5%AF%B9%E8%AF%9D">ä¸äº‹ä»¶å¾ªç¯çš„å¯¹è¯</a>çš„å®éªŒä»£ç ï¼Œæˆ‘åˆå¢åŠ äº†ä¸€äº›å†…å®¹çœ‹æ•ˆæœï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: this is an awaitable object!</span></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nice</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'before yield'</span>)</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    print(<span class="string">"after yield"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="comment"># NEW: this makes ``.send()`` return!</span></span><br><span class="line">    <span class="keyword">await</span> nice()</span><br><span class="line">    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">task = hello(<span class="string">'world'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: call send twice!</span></span><br><span class="line">task.send(<span class="keyword">None</span>)</span><br><span class="line">print(<span class="string">"after first sned"</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    task.send(<span class="keyword">None</span>)</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">before yield</span></span><br><span class="line"><span class="string">after first sned</span></span><br><span class="line"><span class="string">after yield</span></span><br><span class="line"><span class="string">Hello, world!</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¾“å‡ºæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ <code>task.send()</code>ä¼šåœ¨<code>nice()</code>çš„<code>yield</code>å¤„åœä¸‹æ¥ã€‚<code>@coroutine</code>çš„æ³¨è§£ï¼Œè®©<code>nice()</code>å‡½æ•°æˆä¸ºäº†awaitalbeå¯¹è±¡ï¼Œä»è€Œå¯ä»¥<code>await nice()</code>è°ƒç”¨ã€‚</p>
<p>é’ˆå¯¹<a href="#%E7%94%9F%E6%88%90%E5%AD%90%E4%BB%BB%E5%8A%A1">ç”Ÿæˆå­ä»»åŠ¡</a>ï¼Œå‘ç°mainåç¨‹ç»“æŸçš„æ¯”helloåç¨‹æ—©ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> iscoroutine</span><br><span class="line"><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nice</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"before nice"</span>)</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    print(<span class="string">"after nice"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: awaitable object that sends a request to launch a child task!</span></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn</span><span class="params">(task)</span>:</span></span><br><span class="line">    print(<span class="string">"before spawn"</span>)</span><br><span class="line">    <span class="keyword">yield</span> task</span><br><span class="line">    print(<span class="string">"after spawn"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">"hello: before await"</span>)</span><br><span class="line">    <span class="keyword">await</span> nice()</span><br><span class="line">    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: parent task!</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"main: before"</span>)</span><br><span class="line">    <span class="comment"># NEW: create a child task!</span></span><br><span class="line">    <span class="keyword">await</span> spawn(hello(<span class="string">'world'</span>))</span><br><span class="line">    print(<span class="string">"main: after"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line">    <span class="comment"># NEW: schedule the "root" task.</span></span><br><span class="line">    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line">    <span class="keyword">while</span> tasks:</span><br><span class="line">        <span class="comment"># NEW: round-robin between a set tasks (we may now have more than one and we'd like to be as "fair" as possible).</span></span><br><span class="line">        <span class="comment"># æ–°ï¼šä¸€ç»„ä»»åŠ¡ä¹‹é—´çš„å¾ªç¯ï¼ˆæˆ‘ä»¬ç°åœ¨å¯èƒ½æœ‰å¤šä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½â€œå…¬å¹³â€ï¼‰ã€‚</span></span><br><span class="line">        queue, tasks = tasks, []</span><br><span class="line">        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line">            <span class="comment"># NEW: resume the task *once*.</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = task.send(data)</span><br><span class="line">            <span class="keyword">except</span> StopIteration:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line">                <span class="comment"># NEW: prevent crashed task from ending the loop.</span></span><br><span class="line">                print(error)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># NEW: schedule the child task.</span></span><br><span class="line">                <span class="keyword">if</span> iscoroutine(data):</span><br><span class="line">                    tasks.append((data, <span class="keyword">None</span>))</span><br><span class="line">                <span class="comment"># NEW: reschedule the parent task.</span></span><br><span class="line">                tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run_until_complete(main())</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">main: before</span></span><br><span class="line"><span class="string">before spawn</span></span><br><span class="line"><span class="string">hello: before await</span></span><br><span class="line"><span class="string">before nice</span></span><br><span class="line"><span class="string">after spawn</span></span><br><span class="line"><span class="string">main: after</span></span><br><span class="line"><span class="string">after nice</span></span><br><span class="line"><span class="string">Hello, world!</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…å­ä»»åŠ¡join</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nice</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"nice: before yield"</span>)</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    print(<span class="string">"nice: after yield"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn</span><span class="params">(task)</span>:</span></span><br><span class="line">    <span class="comment"># NEW: recover the child task handle to pass it back to the parent.</span></span><br><span class="line">    print(<span class="string">"spawn: before yield"</span>)</span><br><span class="line">    child = <span class="keyword">yield</span> (<span class="string">'spawn'</span>, task)</span><br><span class="line">    print(<span class="string">"spawn: after yield"</span>)</span><br><span class="line">    <span class="keyword">return</span> child</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: awaitable object that sends a request to be notified when a</span></span><br><span class="line"><span class="comment">#      concurrent task completes.</span></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">join</span><span class="params">(task)</span>:</span></span><br><span class="line">    print(<span class="string">"join: before yield"</span>)</span><br><span class="line">    <span class="keyword">yield</span> (<span class="string">'join'</span>, task)</span><br><span class="line">    print(<span class="string">"join: after yield"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">"hello: before nice()"</span>)</span><br><span class="line">    <span class="keyword">await</span> nice()</span><br><span class="line">    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># NEW: recover the child task handle.</span></span><br><span class="line">    child = <span class="keyword">await</span> spawn(hello(<span class="string">'world'</span>))</span><br><span class="line">    print(<span class="string">"main: after spawn and before join()"</span>)</span><br><span class="line">    <span class="comment"># NEW: wait for the child task to complete.</span></span><br><span class="line">    <span class="comment"># ç­‰å¾…å­åç¨‹å®Œæˆ</span></span><br><span class="line">    <span class="keyword">await</span> join(child)</span><br><span class="line">    print(<span class="string">'(after join)'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line">    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line">    <span class="comment"># NEW: keep track of tasks to resume when a task completes.</span></span><br><span class="line">    watch = defaultdict(list)</span><br><span class="line">    <span class="keyword">while</span> tasks:</span><br><span class="line">        queue, tasks = tasks, []</span><br><span class="line">        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = task.send(data)</span><br><span class="line">            <span class="keyword">except</span> StopIteration:</span><br><span class="line">                <span class="comment"># NEW: wait up tasks waiting on this one.</span></span><br><span class="line">                <span class="comment"># å­åç¨‹é€€å‡ºæ—¶, å”¤é†’è¢«joiné˜»å¡çš„çˆ¶åç¨‹</span></span><br><span class="line">                <span class="comment"># å¯¹watchä¸­çš„taskè¿›è¡Œpop, å¦‚æœæ²¡æœ‰åˆ™è¿”å›[]</span></span><br><span class="line">                tasks.extend((t, <span class="keyword">None</span>) <span class="keyword">for</span> t <span class="keyword">in</span> watch.pop(task, []))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># NEW: dispatch request sent by awaitable object since we now have 3 different types of requests.</span></span><br><span class="line">                <span class="comment"># NEW: ç”±ç­‰å¾…å¯¹è±¡å‘é€çš„è°ƒåº¦è¯·æ±‚ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨æœ‰ 3 ç§ä¸åŒç±»å‹çš„è¯·æ±‚</span></span><br><span class="line">                <span class="comment"># 1. å¦‚æœæ˜¯ä¼šäº§ç”Ÿæ–°åç¨‹çš„æ“ä½œ</span></span><br><span class="line">                <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'spawn'</span>:</span><br><span class="line">                    <span class="comment"># å°†æ–°åç¨‹åŠ å…¥</span></span><br><span class="line">                    tasks.append((data[<span class="number">1</span>], <span class="keyword">None</span>))</span><br><span class="line">                    <span class="comment"># å°†çˆ¶åç¨‹å’Œæ–°åç¨‹å†™å…¥, åœ¨task.send(data)ä¸­å¯ä»¥ä½¿å¾—çˆ¶åç¨‹ä¸­èµ‹å€¼child=yield epxä¸ºå­åç¨‹å€¼</span></span><br><span class="line">                    tasks.append((task, data[<span class="number">1</span>]))</span><br><span class="line">                <span class="keyword">elif</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'join'</span>:</span><br><span class="line">                    <span class="comment"># å¦‚æœçˆ¶åç¨‹æ‰§è¡Œçš„å¿«, é‚£ä¹ˆæŠŠå­åç¨‹ä¸çˆ¶åç¨‹çš„ç»‘å®šå…³ç³»è®°å½•ä¸‹æ¥</span></span><br><span class="line">                    watch[data[<span class="number">1</span>]].append(task)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># æ­£å¸¸åç¨‹æ‰§è¡Œç»“æœ</span></span><br><span class="line">                    tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run_until_complete(main())</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">spawn: before yield</span></span><br><span class="line"><span class="string">hello: before nice()</span></span><br><span class="line"><span class="string">nice: before yield</span></span><br><span class="line"><span class="string">spawn: after yield</span></span><br><span class="line"><span class="string">main: after spawn and before join()</span></span><br><span class="line"><span class="string">--- æ­¤æ—¶mainæ‰§è¡Œå®Œæˆ, joinç­‰å¾…nice()è¢«æ‰§è¡Œ</span></span><br><span class="line"><span class="string">join: before yield</span></span><br><span class="line"><span class="string">nice: after yield</span></span><br><span class="line"><span class="string">--- niceæ‰§è¡Œå®Œæˆ</span></span><br><span class="line"><span class="string">Hello, world!</span></span><br><span class="line"><span class="string">--- helloæ‰§è¡Œå®Œæˆ</span></span><br><span class="line"><span class="string">join: after yield</span></span><br><span class="line"><span class="string">--- joinç»“æŸ</span></span><br><span class="line"><span class="string">(after join)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<p>å¤šäº†ä¸¤æ ·ä¸œè¥¿ï¼š</p>
<ul>
<li>æ–°çš„è¯·æ±‚ç±»å‹:
<ul>
<li><code>spawn</code></li>
<li><code>join</code></li>
<li><code>push</code></li>
</ul>
</li>
<li>åŸºäº<code>task.send()</code>è¿”å›å€¼çš„è°ƒåº¦ä»£ç ã€‚</li>
</ul>
<p>é’ˆå¯¹[Sleeping &amp; timers](#Sleeping &amp; timers)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> heapq <span class="keyword">import</span> heappop, heappush</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep <span class="keyword">as</span> _sleep</span><br><span class="line"><span class="keyword">from</span> timeit <span class="keyword">import</span> default_timer</span><br><span class="line"><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: we need to keep track of elapsed time.</span></span><br><span class="line">clock = default_timer</span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: request that the event loop reschedule us "later".</span></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">(seconds)</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> (<span class="string">'sleep'</span>, seconds)</span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: verify elapsed time matches our request.</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line">    ref = clock()</span><br><span class="line">    <span class="keyword">await</span> sleep(<span class="number">3.0</span>)</span><br><span class="line">    now = clock()</span><br><span class="line">    <span class="keyword">assert</span> (now - ref) &gt;= <span class="number">3.0</span></span><br><span class="line">    print(<span class="string">'Hello, %s!'</span> % (name,))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line">    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NEW: keep track of tasks that are sleeping.</span></span><br><span class="line">    timers = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NEW: watch out, all tasks might be suspended at the same time.</span></span><br><span class="line">    <span class="keyword">while</span> tasks <span class="keyword">or</span> timers:</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NEW: if we have nothing to do for now, don't spin.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tasks:</span><br><span class="line">            _sleep(max(<span class="number">0.0</span>, timers[<span class="number">0</span>][<span class="number">0</span>] - clock()))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NEW: schedule tasks when their timer has elapsed.</span></span><br><span class="line">        <span class="comment"># å¦‚æœtimesé˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡, ä¸”æœ€è¿‘çš„æ—¶é—´å·²ç»åˆ°äº†, åˆ™å–å‡ºä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">while</span> timers <span class="keyword">and</span> timers[<span class="number">0</span>][<span class="number">0</span>] &lt; clock():</span><br><span class="line">            _, task = heappop(timers)</span><br><span class="line">            tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line"></span><br><span class="line">        queue, tasks = tasks, []</span><br><span class="line">        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = task.send(data)</span><br><span class="line">            <span class="keyword">except</span> StopIteration:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># NEW: set a timer and don't reschedule right away.</span></span><br><span class="line">                <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">'sleep'</span>:</span><br><span class="line">                    <span class="comment"># å¾€å †é‡Œé¢æ·»åŠ ä»»åŠ¡, é»˜è®¤ä»¥æ—¶é—´æœ€è¿‘çš„åœ¨ä¸Š(æœ€å°å †)</span></span><br><span class="line">                    heappush(timers, (clock() + data[<span class="number">1</span>], task))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># é€’å½’æ·»åŠ ä¸‹ä¸€æ¬¡è¦åšçš„åç¨‹ä»»åŠ¡</span></span><br><span class="line">                    tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line"></span><br><span class="line">run_until_complete(hello(<span class="string">'world'</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> (</span><br><span class="line">    DefaultSelector,</span><br><span class="line">    EVENT_READ,</span><br><span class="line">    EVENT_WRITE,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> socketpair <span class="keyword">as</span> _socketpair</span><br><span class="line"><span class="keyword">from</span> types <span class="keyword">import</span> coroutine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: request that the event loop tell us when we can read.</span></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(stream, size)</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> (EVENT_READ, stream)</span><br><span class="line">    <span class="keyword">return</span> stream.recv(size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: request that the event loop tell us when we can write.</span></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(stream, data)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> data:</span><br><span class="line">        <span class="keyword">yield</span> (EVENT_WRITE, stream)</span><br><span class="line">        size = stream.send(data)</span><br><span class="line">        data = data[size:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: connect sockets, make sure they never, ever block the loop.</span></span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">socketpair</span><span class="params">()</span>:</span></span><br><span class="line">    lhs, rhs = _socketpair()</span><br><span class="line">    lhs.setblocking(<span class="keyword">False</span>)</span><br><span class="line">    rhs.setblocking(<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    <span class="keyword">return</span> lhs, rhs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEW: send a message through the socket pair.</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name)</span>:</span></span><br><span class="line">    lhs, rhs = <span class="keyword">await</span> socketpair()</span><br><span class="line">    <span class="keyword">await</span> send(lhs, <span class="string">'Hello, world!'</span>.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    data = <span class="keyword">await</span> recv(rhs, <span class="number">1024</span>)</span><br><span class="line">    print(data.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    lhs.close()</span><br><span class="line">    rhs.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_until_complete</span><span class="params">(task)</span>:</span></span><br><span class="line">    tasks = [(task, <span class="keyword">None</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NEW: prepare for I/O multiplexing.</span></span><br><span class="line">    selector = DefaultSelector()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NEW: watch out, all tasks might be suspended at the same time.</span></span><br><span class="line">    <span class="keyword">while</span> tasks <span class="keyword">or</span> selector.get_map():</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NEW: poll I/O operation status and resume tasks when ready.</span></span><br><span class="line">        timeout = <span class="number">0.0</span> <span class="keyword">if</span> tasks <span class="keyword">else</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">for</span> key, events <span class="keyword">in</span> selector.select(timeout):</span><br><span class="line">            tasks.append((key.data, <span class="keyword">None</span>))</span><br><span class="line">            selector.unregister(key.fileobj)</span><br><span class="line"></span><br><span class="line">        queue, tasks = tasks, []</span><br><span class="line">        <span class="keyword">for</span> task, data <span class="keyword">in</span> queue:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = task.send(data)</span><br><span class="line">            <span class="keyword">except</span> StopIteration:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># NEW: register for I/O and suspend the task.</span></span><br><span class="line">                <span class="keyword">if</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == EVENT_READ:</span><br><span class="line">                    selector.register(data[<span class="number">1</span>], EVENT_READ, task)</span><br><span class="line">                <span class="keyword">elif</span> data <span class="keyword">and</span> data[<span class="number">0</span>] == EVENT_WRITE:</span><br><span class="line">                    selector.register(data[<span class="number">1</span>], EVENT_WRITE, task)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    tasks.append((task, <span class="keyword">None</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run_until_complete(hello(<span class="string">'world'</span>))</span><br></pre></td></tr></table></figure>
<p>Q: socketpairæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li><code>socket.socketpair()</code>å‡½æ•°ä»…è¿”å›ä¸¤ä¸ªå·²ç»è¿æ¥çš„å¥—æ¥å­—å¯¹è±¡ï¼Œå‚æ•°å’Œsocket.socket()é‡Œçš„å‚æ•°ä¸€æ ·çš„ç”¨æ³•ã€‚</li>
<li><code>socket.socketpair()</code>å¯ä»¥ç†è§£ä¸º åˆ›å»ºäº†ä¸¤ä¸ªsocket, æ¯”å–»ä¸ºä¸€ä¸ªserverçš„ socketï¼Œä¸€ä¸ªclientçš„socketï¼Œè¿™ä¸¤ä¸ªsocketæ˜¯å·²ç»connectedè¿æ¥çŠ¶æ€</li>
<li>socket.socketpair()`æ˜¯å…¨åŒå·¥æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªsocketéƒ½èƒ½æ”¶å‘ï¼Œæ¯”å–»ä¸º\server.sendâ€”&gt;client.recv,å’Œ client.sendâ€”&gt;server.recv</li>
<li>socket.socketpair()`é»˜è®¤æ˜¯åˆ›å»ºunixå¥—æ¥å­—</li>
</ul>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>å‡½æ•°åŠ ä¸Š<code>async def</code>å˜æˆäº†<code>coroutine object</code></li>
<li>å‡½æ•°åŠ ä¸Š<code>@types.coroutine</code>å˜æˆäº†<code>awaitable</code>çš„function</li>
</ul>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="https://nymrli.top">Mrli</a></p><p> <span>Link:  </span><a href="https://nymrli.top/2022/05/08/toy-reimplementation-of-an-event-loop-in-Python-ç¿»è¯‘/">https://nymrli.top/2022/05/08/toy-reimplementation-of-an-event-loop-in-Python-ç¿»è¯‘/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2022/05/09/ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹â€”â€”é˜…è¯»ç¬”è®°/" title="ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹â€”â€”é˜…è¯»ç¬”è®°"><span>< PreviousPost</span><br><span class="prevTitle">ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹â€”â€”é˜…è¯»ç¬”è®°</span></a><a class="nextSlogan" href="/2022/05/05/seleniumä¸è¡Œçš„å·¥ä½œ-pyppeteerä¸Š/" title="seleniumä¸è¡Œçš„å·¥ä½œ,pyppeteerä¸Š"><span>NextPost ></span><br><span class="nextTitle">seleniumä¸è¡Œçš„å·¥ä½œ,pyppeteerä¸Š</span></a><div class="clear"></div></div><div id="comment"><div id="container"></div><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
  id: 'toy reimplementation of an event loop in Python[ç¿»è¯‘]',
  owner: 'Freedomisgood',
  repo: 'Freedomisgood.github.io',
  oauth: {
    client_id: 'bc5a81fe36017dcd8b63',
    client_secret: '949cec3a1b91742c6249c47259791e4b80a6fa69',
  },
})
gitment.render('container')</script></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><p class="beian"><span>å¤‡æ¡ˆå·:è‹ICPå¤‡18015439å·</span></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 60vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå°æ•…äº‹"><span class="toc-number">1.</span> <span class="toc-text"> äº‹ä»¶å¾ªç¯çš„ä¸€ä¸ªå°æ•…äº‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#åç¨‹çš„æœ¬è´¨"><span class="toc-number">1.1.</span> <span class="toc-text"> åç¨‹çš„æœ¬è´¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸äº‹ä»¶å¾ªç¯çš„å¯¹è¯"><span class="toc-number">1.2.</span> <span class="toc-text"> ä¸äº‹ä»¶å¾ªç¯çš„å¯¹è¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#looping"><span class="toc-number">1.3.</span> <span class="toc-text"> Looping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç”Ÿæˆå­ä»»åŠ¡"><span class="toc-number">1.4.</span> <span class="toc-text"> ç”Ÿæˆå­ä»»åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sleeping-timers"><span class="toc-number">1.5.</span> <span class="toc-text"> Sleeping &amp; timers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å¤„ç†io"><span class="toc-number">1.6.</span> <span class="toc-text"> å¤„ç†I/O</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å–æ¶ˆä»»åŠ¡"><span class="toc-number">1.7.</span> <span class="toc-text"> å–æ¶ˆä»»åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è®¸å¯è¯"><span class="toc-number">1.8.</span> <span class="toc-text"> è®¸å¯è¯</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¸ªäººæ”¶è·"><span class="toc-number">2.</span> <span class="toc-text"> ä¸ªäººæ”¶è·</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä¸ªäººå®éªŒ"><span class="toc-number">3.</span> <span class="toc-text"> ä¸ªäººå®éªŒ</span></a></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>