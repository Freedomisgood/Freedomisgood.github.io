<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="果粒橙"><meta name="renderer" content="webkit"><meta name="copyright" content="果粒橙"><meta name="keywords" content="果粒橙的博客"><meta name="description" content="想和你讲，说了会心动 ，缄默会心安。"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>自动化运维工具Ansible · Mr.li's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="https://avatars1.githubusercontent.com/u/31088082?s=400&amp;u=7a99ff83916afb3f4c5312bd78a1be17fe0e34ed&amp;v=4"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Mrli</div><div class="profile-signature">别装作很努力,<br>因为结局不会陪你演戏。</div><div class="contacts"><div>Contacts:</div><span><a href="http://sighttp.qq.com/msgrd?v=1&amp;uin=1063052964" target="_black">QQ</a></span><span><a href="https://www.cnblogs.com/nymrli/" target="_black">博客园</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 60vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Mr.li's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">自动化运维工具Ansible</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-edit"></i><span>2019/08/22</span></span><span class="busuanzi-pv" id="busuanzi_container_page_pv"><i class="post-intro-calendar fa fa-user-o"></i><span id="busuanzi_value_page_pv"></span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="Python"> Python</a><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="运维"> 运维</a></span></div><div class="post-intro-read"><span> Word count: <span class="post-count">3,254</span> | Reading time: <span class="post-count">14</span>min</span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="自动化运维工具Ansible笔记"><a href="#自动化运维工具Ansible笔记" class="headerlink" title="自动化运维工具Ansible笔记"></a>自动化运维工具Ansible笔记</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>​        ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。<br>　　ansible是基于 paramiko 开发的,并且基于模块化工作，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。ansible不需要在远程主机上安装client/agents，因为它们是基于ssh来和远程主机通讯的。ansible目前已经已经被红帽官方收购，是自动化运维工具中大家认可度最高的，并且上手容易，学习简单。是每位运维工程师必须掌握的技能之一。</p>
<h2 id="ansible-特点"><a href="#ansible-特点" class="headerlink" title="ansible 特点"></a>ansible 特点</h2><ol>
<li>部署简单，只需在主控端部署Ansible环境，被控端无需做任何操作；</li>
<li>默认使用<strong>SSH协议</strong>对设备进行管理；</li>
<li>有大量常规运维操作模块，可实现日常绝大部分操作；</li>
<li>配置简单、功能强大、扩展性强；</li>
<li>支持API及自定义模块，<strong>可通过Python轻松扩展</strong>；</li>
<li>通过Playbooks来定制强大的配置、状态管理；</li>
<li>轻量级，<strong>无需在客户端安装agent(代理)</strong>，更新时，只需在操作机上进行一次更新即可；</li>
<li>提供一个功能强大、操作性强的<strong>Web管理界面和REST API接口</strong>——AWX平台。</li>
<li>Ansible适用于中小型应用环境；SaltStack适合大型（Ansible由于不需要代理,只是通过ssh,因此只能性能不如Saltstack高）</li>
</ol>
<h2 id="Ansible安装"><a href="#Ansible安装" class="headerlink" title="Ansible安装"></a>Ansible安装</h2><p>法1.在已有<code>python-pip</code>的情况下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> pip install ansible</span><br></pre></td></tr></table></figure>
<p>法2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install software-properties-common</span><br><span class="line">sudo apt-add-repository ppa:ansible/ansible</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ansible</span><br></pre></td></tr></table></figure>
<p>如果安装失败请换源<code>sudo sed  -i  -re  &#39;s/\w+\.archive\.ubuntu\.com/archive.ubuntu.com/g&#39;  /etc/apt/sources.list</code>,更新安装库<code>sudo apt-get update</code></p>
<h2 id="ansible-架构图"><a href="#ansible-架构图" class="headerlink" title="ansible 架构图"></a>ansible 架构图</h2><p><img src="https://images2017.cnblogs.com/blog/1204916/201712/1204916-20171205163000628-69838828.png" alt="img"><br>　　上图中我们看到的主要模块如下：</p>
<blockquote>
<p><code>Ansible</code>：Ansible核心程序。<br><code>HostInventory</code>：<strong>主机清单</strong> , 记录由Ansible管理的主机信息，包括端口、密码、ip等。<br><code>Playbooks</code>：“剧本”YAML格式文件，多个任务定义在一个文件中，定义主机需要调用哪些模块来完成的功能。<br><code>CoreModules</code>：<strong>核心模块</strong>，主要操作是通过调用核心模块来完成管理任务。<br><code>CustomModules</code>：自定义模块，完成核心模块无法完成的功能，支持多种语言。<br><code>ConnectionPlugins</code>：连接插件，Ansible和Host通信使用</p>
</blockquote>
<h2 id="ansible配置文件查找顺序"><a href="#ansible配置文件查找顺序" class="headerlink" title="ansible配置文件查找顺序"></a>ansible配置文件查找顺序</h2><ol>
<li>检查环境变量<code>ANSIBLE_CONFIG</code>指向的路径文件(export ANSIBLE_CONFIG=/etc/ansible.cfg)；</li>
<li>HOME目录下的配置文件<code>~/.ansible.cfg</code></li>
<li>检查当前目录下的ansible.cfg配置文件；</li>
<li><code>/etc/ansible.cfg</code>检查etc目录的配置文件。</li>
</ol>
<h2 id="使用特性"><a href="#使用特性" class="headerlink" title="使用特性"></a>使用特性</h2><ul>
<li>模块化：调用特定的模块，完成特定任务</li>
<li>有Paramiko，PyYAML，Jinja2（模板语言）三个关键模块支持自定义模块</li>
<li>基于Python语言实现</li>
<li>部署简单，基于python和SSH（默认已安装），agentless安全，基于OpenSSH支持playbook编排任务</li>
<li><strong>幂等性</strong>：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</li>
<li>无需代理不依赖PKI（无需ssl）可使用任何编程语言写模块</li>
<li>YAML格式，编排任务，支持丰富的数据结构</li>
<li>较强大的多层解决方案</li>
</ul>
<h2 id="管理方式"><a href="#管理方式" class="headerlink" title="管理方式:"></a>管理方式:</h2><ul>
<li>Ad-Hoc，及Ansible命令，主要用于临时命令使用场景</li>
<li>Ansible-Playbook，脚本，用于长期规划好，大型项目的场景，需要有提前的规划</li>
</ul>
<p>Ansible-playbook（剧本）执行过程：</p>
<ul>
<li>将已有编排好的任务集写入Ansible-Playbook</li>
<li>通过ansible-playbook命令分拆任务集至逐条ansible命令，按预定规则逐条执行</li>
</ul>
<h2 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性<br>/etc/ansible/hosts 主机清单<br>/etc/ansible/roles/存放角色的目录</p>
<h3 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h3><p>/usr/bin/ansible 主程序，临时命令执行工具<br>/usr/bin/ansible-doc 查看配置文档，模块功能查看工具<br>/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台<br>/usr/bin/ansible-playbook定制自动化任务，编排剧本工具/usr/bin/ansible-pull远程执行命令的工具<br>/usr/bin/ansible-vault 文件加密工具<br>/usr/bin/ansible-console 基于console界面与用户交互的执行工具</p>
<p>1.设置被管理的主机清单<code>vim /etc/ansible/hosts</code></p>
<p>2.1口令验证方式.<code>ansible 192.168.30.101 -m ping -k</code>用账号密码去确认受控端的身份</p>
<p>▲如果出现了这样的情况,需要先安装sshpass , <code>sudo apt install sshpass</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.180 | FAILED! =&gt; &#123;</span><br><span class="line">    "failed": true, </span><br><span class="line">    "msg": "ERROR! to use the 'ssh' connection type with passwords, you must install the sshpass program"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.2基于key验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ssh-keygen</span><br><span class="line"><span class="meta">$</span> ssh-copy-id 192.168.30.101</span><br><span class="line"></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/xxxxxx/): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in xxxxxxxxx.</span><br><span class="line">Your public key has been saved in xxxxx.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:xxxxxxxxxxxxxx</span><br><span class="line">The key's randomart image is:</span><br></pre></td></tr></table></figure>
<p>如果设置了passphrase,那么链接时需要输入passphrase,如果是ad-hoc就相当麻烦,而playbooks中有解决方法</p>
<h2 id="ad-hoc使用"><a href="#ad-hoc使用" class="headerlink" title="ad-hoc使用"></a>ad-hoc使用</h2><p>将<code>host_key_checking</code>取消注释,否则链接对象必须在known_hosts中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo vim /etc/ansible/ansible.cfg</span><br><span class="line"><span class="meta">#</span> uncomment this to disable SSH key host checking</span><br><span class="line"><span class="meta">#</span>host_key_checking = False</span><br></pre></td></tr></table></figure>
<p>显示日志,取消注释<code>log_path = /var/log/ansible.log</code></p>
<p>△.ansible不是长期执行的服务,不长期执行,因此修改配置后不需要重启服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible &lt;host-pattern&gt;[-m module_name][-a args]</span><br><span class="line"></span><br><span class="line">ansible dbsrvs -m command -a 'ls /root'-u wang-k -b-K</span><br><span class="line"><span class="meta">#</span> -u 以wang的身份登录,-b将wang切换成root,-K 输入root密码.</span><br><span class="line"><span class="meta">#</span> -m 指定模块名,-a指定模块参数</span><br></pre></td></tr></table></figure>
<h2 id="ansible的Host-pattern即匹配主机的列表"><a href="#ansible的Host-pattern即匹配主机的列表" class="headerlink" title="ansible的Host-pattern即匹配主机的列表"></a>ansible的Host-pattern即匹配主机的列表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">All：表示所有Inventory中的所有主机</span><br><span class="line">ansible all-m ping</span><br><span class="line">：通配符</span><br><span class="line">ansible&quot;&quot;-m ping</span><br><span class="line">ansible 192.168.1.-m ping</span><br><span class="line">ansible&quot;srvs&quot;-m ping</span><br><span class="line">或关系</span><br><span class="line">ansible&quot;websrvsiappsrvs&quot;-m ping</span><br><span class="line">ansible&quot;192.168.1.10：192.168.1.20&quot;-m ping</span><br></pre></td></tr></table></figure>
<p>逻辑与<br><code>ansible&quot;websrvs:&amp;dbsrvs&quot;-m ping</code>在websrvs组并且在dbsrvs组中的主机,单引号、双引号都行</p>
<p>逻辑非<br><code>ansible websrvs:ldbsrvs&#39;-m ping</code>在websrvs组，但不在dbsrvs组中的主机<br>注意：<strong>此处为单引号</strong></p>
<p>综合逻辑<br><code>ansible‘websrvs:dbsrvs:&amp;appsrvs:lftpsrvs&#39;-m ping</code></p>
<p>正则表达式<br><code>ansible&quot;websrvs:&amp;dbsrvs&quot;-m ping</code></p>
<p><code>ansible&quot;~（webldb）.*\.magedu\.com&quot;-m ping</code></p>
<h2 id="ansible-command"><a href="#ansible-command" class="headerlink" title="ansible command"></a>ansible command</h2><ul>
<li>creates=<ul>
<li>存在,不执行</li>
</ul>
</li>
<li>removes=<ul>
<li>不存在,不执行</li>
</ul>
</li>
<li>chdir=<ul>
<li>切换目录后执行</li>
</ul>
</li>
</ul>
<h2 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h2><ul>
<li>command</li>
<li>shell<ul>
<li><code>ansible all -m shel1-a &#39;getenforce&#39;</code></li>
</ul>
</li>
<li>script</li>
<li>copy<ul>
<li><code>ansible all -m copy -a&#39;src=/root/ansible/selinux dest=/etc/selinux/config backup=yes&#39;</code></li>
<li><code>ansible all -m copy-a &#39;src=/etc/shadow dest=/data/mode=000 owner=wang&#39;</code></li>
</ul>
</li>
<li>fetch<ul>
<li><code>ansible srv-m fetch -a &#39;src=/root/a. sh dest=/data/scripts&#39;</code></li>
</ul>
</li>
<li>file<ul>
<li>文件操作,删除、创建</li>
</ul>
</li>
<li>unachieve、achieve<ul>
<li>压缩解压</li>
</ul>
</li>
<li>cron<ul>
<li>开启<code>ansible all-m cron -a &#39;minute=* weekday=1,3,5 jcb=&quot;/usr/bin/wall FBI warning&quot; name=warningcron&#39;</code></li>
<li>禁用<code>ansible all -m cron -a &#39;disabled=true job=&quot;/usr/bin/wall FBI warning&quot;name=warningcron&#39;</code>、启用<code>ansible all -m cron -a &#39;disabled=falsejob=&quot;/usr/bin/wall FBI warning&quot;name=warningcron&#39;</code></li>
<li>删除<code>ansible all -m cron -a &#39;job=&quot;/usr/bin/wall FBI warning&quot;name=warningcron state=absent&#39;</code></li>
</ul>
</li>
<li>apt、yum</li>
<li>user</li>
<li>group</li>
<li>service<ul>
<li><code>service:name=httpd state=started enabled=yes</code></li>
</ul>
</li>
<li>setup<ul>
<li><code>ansible websrvs -m setup -a &#39;filter=*address*&#39;</code></li>
</ul>
</li>
<li>template(不能放在ad-hoc)中,只能在playbook中使用</li>
</ul>
<p>command模块在针对<strong>管道</strong>、<strong>重定向有*…</strong>有问题==&gt;使用shell模块</p>
<p><a href="https://www.cnblogs.com/ExzaiTin/p/7918415.html" target="_blank" rel="noopener">常用模块介绍</a></p>
<h2 id="系列命令"><a href="#系列命令" class="headerlink" title="系列命令"></a>系列命令</h2><h3 id="galaxy"><a href="#galaxy" class="headerlink" title="galaxy"></a>galaxy</h3><p><code>ansible-galaxy install geerlingguy.nginx</code>    其中<code>geerlingguy</code>为角色在<code>./ansible/roles/</code></p>
<h3 id="playbooks"><a href="#playbooks" class="headerlink" title="playbooks"></a>playbooks</h3><blockquote>
<p>Yaml</p>
<p>YAML Ain’t Markup Language，即YAML不是XML。不过，在开发的这种语言时，YAML的意思其实是：”Yet Another Markup Language”（仍是一种标记语言）</p>
</blockquote>
<h4 id="核心元素"><a href="#核心元素" class="headerlink" title="核心元素"></a>核心元素</h4><ul>
<li>Hosts 执行的远程主机列表</li>
<li>Tasks 任务集</li>
<li>Varniables 内置变量或自定义变量在playbook中调用Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件Handlers 和notity结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li>
<li>tags 标签指定某条任务执行，用于选择运行playbook中的部分代码。<ul>
<li>ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断<br>ansible-playbook-t tagsname useradd.yml</li>
</ul>
</li>
</ul>
<h3 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h3><p>加密<code>ansible-vault encrypt hello.yml</code></p>
<p>解密查看<code>ansible-vault view hello.yml</code></p>
<p>重新制定口令<code>ansible-vault rekey hello.yml</code></p>
<h2 id="基础组件"><a href="#基础组件" class="headerlink" title="基础组件"></a>基础组件</h2><p>如果命令或脚本的退出码不为零，可以使用如下方式替代</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span><span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    shell:</span><span class="string">/usr/bin/somecommand</span> <span class="string">||/bin/true</span></span><br></pre></td></tr></table></figure>
<p>或者使用ignore_errors来忽略错误信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">tasks：</span></span><br><span class="line"><span class="attr">  - name:</span><span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    shell:</span><span class="string">/usr/bin/somecommand</span></span><br><span class="line"><span class="attr">ignore_errors:</span><span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h2 id="运行playbook的方式"><a href="#运行playbook的方式" class="headerlink" title="运行playbook的方式"></a>运行playbook的方式</h2><p><code>ansible-playbook &lt;filename.yml&gt;..[options]</code><br>常见选项<br><code>-check(-C)</code>只检测可能会发生的改变，但不真正执行操作<br><code>--list-hosts</code>列出运行任务的主机<br><code>--limit</code>主机列表只针对主机列表中的主机执行<br><code>-V</code>显示过程-vw-vwv更详细</p>
<h2 id="handlers和notify"><a href="#handlers和notify" class="headerlink" title="handlers和notify"></a>handlers和notify</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span><span class="string">instal1</span> <span class="string">httpd</span> <span class="string">package</span> </span><br><span class="line"><span class="attr">    yum:</span><span class="string">name=httpd</span> </span><br><span class="line"><span class="attr">  - name:</span><span class="string">copy</span> <span class="string">conf</span> <span class="string">file</span> <span class="attr">copy:src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/backup=yes</span> </span><br><span class="line"><span class="attr">    notify:</span><span class="string">restart</span> <span class="string">service</span> </span><br><span class="line"><span class="attr">  - name:</span><span class="string">start</span> <span class="string">service</span></span><br><span class="line"><span class="attr">    service:</span><span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span> </span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span><span class="string">restart</span> <span class="string">service</span> </span><br><span class="line"><span class="attr">      service:</span><span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<p>标签</p>
<blockquote>
<p>指定标签来执行指定任务</p>
</blockquote>
<p><code>ansible-playbook -t  rshttp,xxxx httpd.yml</code></p>
<h2 id="变量使用"><a href="#变量使用" class="headerlink" title="变量使用"></a>变量使用</h2><p>jinjia2语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; var &#125;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>法一：ansible setup facts 远程主机的所有变量都可直接调用</li>
<li>法二：在<code>/etc/ansible/hosts</code>中定义普通变量：主机组中主机单独定义，优先级高于公共变量公共（组）变量：针对主机组中所有主机定义统一变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[websrvs]</span><br><span class="line">192.168.30.101 http_port=81</span><br><span class="line">192.168.30.102 http_port=82</span><br><span class="line">[websrvs:vars]</span><br><span class="line">nodename=www </span><br><span class="line">domainname=magedu.com</span><br></pre></td></tr></table></figure>
<ul>
<li>法三：<code>ansible-playbook -e &#39;var=xxx&#39; app.html</code>，优先级比法二高</li>
<li>法四:</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> </span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span> </span><br><span class="line"><span class="attr">    - var:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> </span><br><span class="line"><span class="attr">       yum:</span> <span class="string">...</span></span><br></pre></td></tr></table></figure>
<h2 id="迭代机制"><a href="#迭代机制" class="headerlink" title="迭代机制"></a>迭代机制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - name:</span><br><span class="line">    file: name=/data/&#123;&#123; item &#125;&#125;</span><br><span class="line">    with_items: </span><br><span class="line">      - file1</span><br><span class="line">      - file2</span><br><span class="line">      - file3</span><br></pre></td></tr></table></figure>
<h3 id="迭代嵌套自变量"><a href="#迭代嵌套自变量" class="headerlink" title="迭代嵌套自变量"></a>迭代嵌套自变量</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span> </span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span> </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span> </span><br><span class="line"><span class="attr">    group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">]&#125;</span> <span class="string">state=present</span> </span><br><span class="line"><span class="attr">    with_items:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">group1</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">group2</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">group3</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span> </span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.</span> <span class="string">name</span> <span class="string">]&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.</span> <span class="string">group</span> <span class="string">)&#125;</span> <span class="string">state=present</span> </span><br><span class="line">      <span class="string">with</span> <span class="attr">items:</span></span><br><span class="line"><span class="bullet">        -</span><span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">user1,</span> <span class="attr">group:'</span> <span class="string">group1'&#125;</span></span><br><span class="line"><span class="bullet">        -</span><span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user2, group:'</span> <span class="string">group2'&#125;</span></span><br><span class="line"><span class="bullet">        -</span><span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user3'</span><span class="string">,</span> <span class="attr">group:'</span> <span class="string">group3'&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for vhost in nginx_vhosts%&#125;</span><br><span class="line">server&#123;</span><br><span class="line">listen&#123;&#123; vhost &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span><span class="string">websrvs</span> </span><br><span class="line"><span class="attr">  remote_user:</span><span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">      - listen_port:</span><span class="number">81</span></span><br><span class="line"><span class="attr">      - listen_port:</span><span class="number">82</span></span><br><span class="line"><span class="attr">      - listen_port:</span><span class="number">83</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span><span class="string">copy</span> <span class="string">conf</span> </span><br><span class="line"><span class="attr">    template:</span><span class="string">src=forl.conf.j2</span> <span class="string">dest=/data/for1.conf</span></span><br></pre></td></tr></table></figure>
<h2 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h2><blockquote>
<p>ansilbe自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用<strong>include</strong>指令即可。简单来讲，roles就是通过分别将<strong>变量</strong>、<strong>文件</strong>、<strong>任务</strong>、<strong>模板</strong>及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中</p>
</blockquote>
<p>复杂场景：建议使用roles，代码复用度高</p>
<ul>
<li>变更指定主机或主机组</li>
<li>如命名不规范维护和传承成本大</li>
<li>某些功能需多个Playbook，通过Includes即可实现</li>
</ul>
<p>roles目录结构：<br>playbook.yml<br>roles/<br>project/<br>tasks/<br>files/<br>vars/不常用<br>default/不常用<br>templates/<br>handlers/<br>meta/不常用</p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="Ansible-配置SSH公钥认证"><a href="#Ansible-配置SSH公钥认证" class="headerlink" title="Ansible 配置SSH公钥认证"></a>Ansible 配置SSH公钥认证</h3><p>安装好Ansible之后，要开始工作，还需要创建一个被控制主机列表清单.默认读取/etc/ansible/hosts,如果该文件不存在，则要收到进行创建.</p>
<p> 也可以通过环境变量 <strong>ANSIBLE_INVENTORY</strong> 来设置默认清单文件,1.9版本之前用 <strong>ANSIBLE_HOSTS</strong><code>export ANSIBLE_INVENTORY=~/ansible_hosts</code>  </p>
<p><strong>创建SSH认证文件</strong></p>
<blockquote>
<p>该操作是在控制主机中进行。</p>
</blockquote>
<p>SSH认证文件创建成功之后，将控制主机的公钥文件 id_rsa.pub 添加到被控制主机的~/.ssh/authorized_keys。</p>
<p><code>\#  ~</code>指的是控制主机和被控制主机通信的用户家目录。</p>
<p><code>\#  id_rsa</code> 是控制主机的私钥文件，要严格保管。</p>
<p><code>\#  id_rsa.pub</code>是控制主机的公钥文件，可随意分发。</p>
<p>法一:<code>ansible all -m shell -a &quot;cat /tmp/authorized_keys &gt;&gt; /root/.ssh/authorized_keys&quot; -k</code></p>
<p>▲注意</p>
<blockquote>
<p><strong>如果被控制主机中用户家目录中不存在.ssh目录，就创建。</strong></p>
<p><strong>然后将上传的公钥文件追加到用户的authorized_keys文件中</strong></p>
</blockquote>
<p>法二: </p>
<p>通过authorized_key模块来进行添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible para -i /tmp/inventory.txt -m authorized_key -a <span class="string">"user=root key='&#123;&#123; lookup('file','/root/.ssh/id_rsa.pub') &#125;&#125;'"</span> -k</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>lookup(&#39;file&#39;,&#39;/root/.ssh/id_rsa.pub&#39;)</code> 是读取/root/.ssh/id_rsa.pub的内容</p>
</blockquote>
<p>一键挂载NFS:</p>
<p><code>ansible full -m mount -a &quot;name=/data src=192.168.100.179:/data fstype=nfs state=mounted&quot; -b -K</code></p>
<p>挂载需要用SUDO权限,所以-K必不可少.同时,在这之前已经使用过ssh进行了配对因此不需要输入登录用户密码.</p>
<p><code>ss -ntl | grep 80</code></p>
<p><code>vim /etc/sysconfig/network-scripts/ifcfg-eth0</code>建议可以使用Alias</p>
<p><code>service network restart</code>重启网络服务</p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="https://nymrli.top">果粒橙</a></p><p> <span>Link:  </span><a href="https://nymrli.top/2019/07/08/自动化运维工具Ansible/">https://nymrli.top/2019/07/08/自动化运维工具Ansible/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/07/13/通过XDRP实现Windows远程访问ubuntu桌面/" title="通过XDRP实现Windows远程访问ubuntu桌面"><span>< PreviousPost</span><br><span class="prevTitle">通过XDRP实现Windows远程访问ubuntu桌面</span></a><a class="nextSlogan" href="/2019/07/07/staticmethod和classmethod区别/" title="staticmethod和classmethod区别"><span>NextPost ></span><br><span class="nextTitle">staticmethod和classmethod区别</span></a><div class="clear"></div></div><div id="comment"><div id="container"></div><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
  id: '自动化运维工具Ansible',
  owner: 'Freedomisgood',
  repo: 'Freedomisgood.github.io',
  oauth: {
    client_id: 'bc5a81fe36017dcd8b63',
    client_secret: '949cec3a1b91742c6249c47259791e4b80a6fa69',
  },
})
gitment.render('container')</script></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 60vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#自动化运维工具Ansible笔记"><span class="toc-number">1.</span> <span class="toc-text">自动化运维工具Ansible笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-特点"><span class="toc-number">1.2.</span> <span class="toc-text">ansible 特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ansible安装"><span class="toc-number">1.3.</span> <span class="toc-text">Ansible安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-架构图"><span class="toc-number">1.4.</span> <span class="toc-text">ansible 架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible配置文件查找顺序"><span class="toc-number">1.5.</span> <span class="toc-text">ansible配置文件查找顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用特性"><span class="toc-number">1.6.</span> <span class="toc-text">使用特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#管理方式"><span class="toc-number">1.7.</span> <span class="toc-text">管理方式:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关文件"><span class="toc-number">1.8.</span> <span class="toc-text">相关文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置文件"><span class="toc-number">1.8.1.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#程序"><span class="toc-number">1.8.2.</span> <span class="toc-text">程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ad-hoc使用"><span class="toc-number">1.9.</span> <span class="toc-text">ad-hoc使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible的Host-pattern即匹配主机的列表"><span class="toc-number">1.10.</span> <span class="toc-text">ansible的Host-pattern即匹配主机的列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ansible-command"><span class="toc-number">1.11.</span> <span class="toc-text">ansible command</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常用模块"><span class="toc-number">1.12.</span> <span class="toc-text">常用模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#系列命令"><span class="toc-number">1.13.</span> <span class="toc-text">系列命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#galaxy"><span class="toc-number">1.13.1.</span> <span class="toc-text">galaxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#playbooks"><span class="toc-number">1.13.2.</span> <span class="toc-text">playbooks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#核心元素"><span class="toc-number">1.13.2.1.</span> <span class="toc-text">核心元素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加密"><span class="toc-number">1.13.3.</span> <span class="toc-text">加密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础组件"><span class="toc-number">1.14.</span> <span class="toc-text">基础组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行playbook的方式"><span class="toc-number">1.15.</span> <span class="toc-text">运行playbook的方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#handlers和notify"><span class="toc-number">1.16.</span> <span class="toc-text">handlers和notify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#变量使用"><span class="toc-number">1.17.</span> <span class="toc-text">变量使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#迭代机制"><span class="toc-number">1.18.</span> <span class="toc-text">迭代机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#迭代嵌套自变量"><span class="toc-number">1.18.1.</span> <span class="toc-text">迭代嵌套自变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#roles"><span class="toc-number">1.19.</span> <span class="toc-text">roles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附录"><span class="toc-number">1.20.</span> <span class="toc-text">附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ansible-配置SSH公钥认证"><span class="toc-number">1.20.1.</span> <span class="toc-text">Ansible 配置SSH公钥认证</span></a></li></ol></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>