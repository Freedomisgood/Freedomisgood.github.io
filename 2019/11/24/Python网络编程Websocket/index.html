<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="Mrli"><meta name="renderer" content="webkit"><meta name="copyright" content="Mrli"><meta name="keywords" content="Mrli's Blog"><meta name="description" content="想和你讲，说了会心动 ，缄默会心安。"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Python网络编程Websocket · Mr.li's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="https://avatars1.githubusercontent.com/u/31088082?s=400&amp;u=7a99ff83916afb3f4c5312bd78a1be17fe0e34ed&amp;v=4"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Mrli</div><div class="profile-signature">别装作很努力,<br>因为结局不会陪你演戏。</div><div class="contacts"><div>Contacts:</div><span><a href="http://sighttp.qq.com/msgrd?v=1&amp;uin=1063052964" target="_black">QQ</a></span><span><a href="https://www.cnblogs.com/nymrli/" target="_black">博客园</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 60vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Mr.li's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">Python网络编程Websocket</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-edit"></i><span>2019/11/24</span></span><span class="busuanzi-pv" id="busuanzi_container_page_pv"><i class="post-intro-calendar fa fa-user-o"></i><span id="busuanzi_value_page_pv"></span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="Python"> Python</a><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="网络知识"> 网络知识</a></span></div><div class="post-intro-read"><span> Word count: <span class="post-count">5,414</span> | Reading time: <span class="post-count">28</span>min</span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h1 id="网络知识websocket"><a class="markdownIt-Anchor" href="#网络知识websocket"></a> 网络知识——Websocket</h1>
<ul>
<li>
<p>TCP ：面向连接—&gt; 打电话(相互回复,一来一回)，客户端向服务器端 拨号 , 三次握手 ,</p>
</li>
<li>
<p>UDP : 面向无连接 --&gt; 寄快递(寄出去就不管了) e.g.直播</p>
</li>
</ul>
<p><strong>UDP四层结构</strong></p>
<ul>
<li>网络访问层(链路层):  物理连接设备(网线)、MAC地址（物理地址）</li>
<li>互联网层： IP地址（定位设备）</li>
<li>传输层： port (端口号) : 表示通信进程,将数据交给哪个应用处理</li>
<li>应用层： 自己定义的协议（处理字符串消息的方法）</li>
</ul>
<p>套接字(socket) ： 特殊的设备文件 ， 写网络应用程序的接口，写入后就是发送，接收就是读取。 类似于 esp8266吧…</p>
<p><strong>基本的socket操作</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_DGRAM) </span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">参数说明:</span></span><br><span class="line"><span class="string">AF_INET IPv4</span></span><br><span class="line"><span class="string">----</span></span><br><span class="line"><span class="string">STREAM TCP</span></span><br><span class="line"><span class="string">SOCK_DGRAM UDP,无listen、accpet</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">server_addr = (<span class="string">'127.0.0.1'</span>,<span class="number">8888</span>)    <span class="comment"># 本地回环地址 , 端口</span></span><br><span class="line">s.bind(server_addr)                                    <span class="comment"># 绑定、传入信息</span></span><br><span class="line">data, cilent_addr = s.recvfrom(<span class="number">1024</span>)        <span class="comment"># BUF_SIZE指定接收数据长度 , (数据内容,客户端地址)</span></span><br><span class="line">s.sendto(data,cilent_addr)                        <span class="comment"># 给客户端发送数据</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">buf = <span class="number">1024</span></span><br><span class="line">ADDR = (<span class="string">"127.0.0.1"</span>, <span class="number">8999</span>)</span><br><span class="line">tcpSock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">tcpSock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">tcpSock.bind(ADDR)</span><br><span class="line">tcpSock.listen(<span class="number">5</span>)</span><br><span class="line">conn, addr = tcpSock.accept()</span><br></pre></td></tr></table></figure>
<h3 id="什么是webscoket"><a class="markdownIt-Anchor" href="#什么是webscoket"></a> 什么是webscoket？</h3>
<p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行<strong>全双工通讯</strong>的协议。HTML5 WebSocket 设计出来的目的就是要<strong>取代轮询</strong>和 Comet 技术，使客户端浏览器具备像 C/S 架构下桌面系统的实时通讯能力。</p>
<p>WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端<strong>主动</strong>向客户端推送数据。在WebSocket API 中，浏览器和服务器只需要完成<strong>一次握手</strong>，两者之间就直接可以创建持久性的连接，并进行双向数据传输，其本质是保持TCP连接。</p>
<ul>
<li>客户端 : 发送数据、接收返回数据端</li>
<li>服务端: 处理数据端</li>
</ul>
<p><strong>服务端</strong></p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,base64,hashlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_headers</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="string">'''提取请求头,将请求头转换为字典'''</span></span><br><span class="line">    header_dict = &#123;&#125;</span><br><span class="line">    data = str(data,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line">    header,body = data.split(<span class="string">"\r\n\r\n"</span>,<span class="number">1</span>)</span><br><span class="line">    header_list = header.split(<span class="string">"\r\n"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(header_list)):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> len(header_list[<span class="number">0</span>].split(<span class="string">" "</span>)) == <span class="number">3</span>:</span><br><span class="line">                header_dict[<span class="string">'method'</span>],header_dict[<span class="string">'url'</span>],header_dict[<span class="string">'protocol'</span>] = header_list[<span class="number">0</span>].split(<span class="string">" "</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            k,v=header_list[i].split(<span class="string">":"</span>,<span class="number">1</span>)</span><br><span class="line">            header_dict[k]=v.strip()</span><br><span class="line">    <span class="keyword">return</span> header_dict</span><br><span class="line"></span><br><span class="line">sock = socket.socket()</span><br><span class="line">sock.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 指定IP和侦听端口Port</span></span><br><span class="line">sock.bind((<span class="string">"127.0.0.1"</span>,<span class="number">8888</span>))</span><br><span class="line">sock.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#等待用户连接</span></span><br><span class="line">conn,addr = sock.accept()</span><br><span class="line">print(<span class="string">"conn from "</span>,conn,addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取握手消息，magic string ,sha1加密</span></span><br><span class="line"><span class="comment">#发送给客户端</span></span><br><span class="line"><span class="comment">#握手消息</span></span><br><span class="line">data = conn.recv(<span class="number">8096</span>)</span><br><span class="line">headers = get_headers(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对请求头中的sec-websocket-key进行加密,需要返回的头</span></span><br><span class="line">response_tpl = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span> \</span><br><span class="line">      <span class="string">"Upgrade:websocket\r\n"</span> \</span><br><span class="line">      <span class="string">"Connection: Upgrade\r\n"</span> \</span><br><span class="line">      <span class="string">"Sec-WebSocket-Accept: %s\r\n"</span> \</span><br><span class="line">      <span class="string">"WebSocket-Location: ws://%s%s\r\n\r\n"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># magic_string为一个固定的字符串</span></span><br><span class="line">magic_string = <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密</span></span><br><span class="line">value = headers[<span class="string">'Sec-WebSocket-Key'</span>] + magic_string</span><br><span class="line">ac = base64.b64encode(hashlib.sha1(value.encode(<span class="string">'utf-8'</span>)).digest())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回的信息</span></span><br><span class="line">response_str = response_tpl % (ac.decode(<span class="string">'utf-8'</span>), headers[<span class="string">'Host'</span>], headers[<span class="string">'url'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 响应【握手】信息</span></span><br><span class="line">conn.send(bytes(response_str, encoding=<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="comment">#复制代码</span></span><br></pre></td></tr></table></figure>
<p><strong>客户端</strong></p>
<p><em>Python</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> thread</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">import</span> _thread <span class="keyword">as</span> thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># import websocket</span></span><br><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ws = websocket.WebSocket()</span></span><br><span class="line">ws = websocket.create_connection(<span class="string">"ws://127.0.0.1:8999/"</span>)</span><br><span class="line"><span class="comment"># ws.connect("ws://127.0.0.1:8999/")</span></span><br><span class="line">data = &#123;<span class="string">"body"</span>:&#123;<span class="string">"address"</span>:<span class="string">"陕西省"</span>&#125;&#125;</span><br><span class="line">ws.send(json.dumps(data))   <span class="comment">#json转化为字符串，必须转化</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    data = ws.recv()</span><br><span class="line">    print(data)</span><br></pre></td></tr></table></figure>
<p><strong>Java Script</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    ws =<span class="keyword">new</span> WebSocket(<span class="string">"ws://127.0.0.1:8080"</span>);</span></span><br><span class="line"><span class="actionscript">    ws.onopen = <span class="function"><span class="keyword">function</span> <span class="params">(ev)</span> </span>&#123; </span></span><br><span class="line"><span class="actionscript">        <span class="comment">//若是连接成功，onopen函数会执行</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(ev)</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>大端和小端模式</strong></p>
<p>网络通信时 通常使用大端</p>
<h3 id="解析websocket协议"><a class="markdownIt-Anchor" href="#解析websocket协议"></a> 解析websocket协议</h3>
<p><strong>使用、创建demo：</strong></p>
<p>长连接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> thread</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">import</span> _thread <span class="keyword">as</span> thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(ws, message)</span>:</span></span><br><span class="line">    print(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_error</span><span class="params">(ws, error)</span>:</span></span><br><span class="line">    print(error)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_close</span><span class="params">(ws)</span>:</span></span><br><span class="line">    print(<span class="string">"### closed ###"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_open</span><span class="params">(ws)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(*args)</span>:</span></span><br><span class="line">        ws.send(<span class="string">"hello1"</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        ws.close()</span><br><span class="line">    thread.start_new_thread(run,())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    websocket.enableTrace(<span class="keyword">True</span>)</span><br><span class="line">    ws = websocket.WebSocketApp(<span class="string">"ws://echo.websocket.org/"</span>,</span><br><span class="line">                              on_message = on_message,</span><br><span class="line">                              on_error = on_error,</span><br><span class="line">                              on_close = on_close)</span><br><span class="line">    ws.on_open = on_open</span><br><span class="line">    ws.run_forever(ping_interval=<span class="number">60</span>,ping_timeout=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>▲ Python的websocket代码是仿js websocket写法的，重新写了一遍脚本，流畅接受消息，自动重连发送指令，连接时间明显减少，基本做到无遗漏数据，与网站js的ws连接实现一样。</p>
<p>短链接：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> websocket <span class="keyword">import</span> create_connection</span><br><span class="line">ws = create_connection(<span class="string">"ws://echo.websocket.org/"</span>)</span><br><span class="line">print(<span class="string">"Sending 'Hello, World'..."</span>)</span><br><span class="line">ws.send(json.dumps(&#123;<span class="string">"op"</span>:<span class="string">"unconfirmed_sub"</span>&#125;)) <span class="comment"># 不能使用str()，要以json格式输出</span></span><br><span class="line">ws.send(<span class="string">"Hello, World"</span>)</span><br><span class="line">print(<span class="string">"Sent"</span>)</span><br><span class="line">print(<span class="string">"Receiving..."</span>)</span><br><span class="line">result =  ws.recv()</span><br><span class="line">print(<span class="string">"Received '%s'"</span> % result)</span><br><span class="line">ws.close()</span><br></pre></td></tr></table></figure>
<h4 id="一步一步分析请求过程"><a class="markdownIt-Anchor" href="#一步一步分析请求过程"></a> 一步一步分析请求过程！！</h4>
<blockquote>
<ul>
<li>
<p>服务端（socket服务端）<br>
*1.服务端开启socket服务监听IP和端口<br>
*3.允许连接<br>
*5.服务端接收到特殊值【加密sha1，特殊值，migic string=“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”】<br>
*6.加密后的值发送给客户端</p>
</li>
<li>
<p>客户端（浏览器）</p>
</li>
</ul>
<p>*2.客户端发起连接请求（IP和端口）<br>
*4.客户端生成一个xxx，【加密sha1，特殊值，migic string=“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”】，向服务端发送一段特殊值<br>
*7.客户端接收到加密的值</p>
</blockquote>
<h5 id="1-启动服务端"><a class="markdownIt-Anchor" href="#1-启动服务端"></a> 1. 启动服务端</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">sock.bind((<span class="string">'127.0.0.1'</span>, <span class="number">8002</span>))</span><br><span class="line">sock.listen(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># 等待用户连接</span></span><br><span class="line">conn, address = sock.accept()</span><br></pre></td></tr></table></figure>
<h5 id="2-客户端连接"><a class="markdownIt-Anchor" href="#2-客户端连接"></a> 2. 客户端连接</h5>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">"ws://127.0.0.1:8002/xxoo"</span>);</span></span><br><span class="line"><span class="undefined">    ...</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-建立连接握手"><a class="markdownIt-Anchor" href="#3-建立连接握手"></a> 3. 建立连接【握手】</h5>
<h6 id="获取请求信息"><a class="markdownIt-Anchor" href="#获取请求信息"></a> 获取请求信息</h6>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"> </span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">sock.bind((<span class="string">'127.0.0.1'</span>, <span class="number">8002</span>))</span><br><span class="line">sock.listen(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># 获取客户端socket对象</span></span><br><span class="line">conn, address = sock.accept()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取客户端的【握手】信息</span></span><br><span class="line">data = conn.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">b'''</span></span><br><span class="line"><span class="string">GET /chatsocket HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1:8002</span></span><br><span class="line"><span class="string">Connection: Upgrade</span></span><br><span class="line"><span class="string">Pragma: no-cache</span></span><br><span class="line"><span class="string">Cache-Control: no-cache</span></span><br><span class="line"><span class="string">Upgrade: websocket</span></span><br><span class="line"><span class="string">Origin: http://localhost:63342</span></span><br><span class="line"><span class="string">Sec-WebSocket-Version: 13</span></span><br><span class="line"><span class="string">Sec-WebSocket-Key: mnwFxiOlctXFN/DeMt1Amg==</span></span><br><span class="line"><span class="string">Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<p>请求和响应的【握手】信息需要遵循规则：</p>
<ul>
<li>从请求【握手】信息中提取 Sec-WebSocket-Key</li>
<li>利用magic_string 和 Sec-WebSocket-Key 进行hmac1加密，再进行base64加密</li>
<li>将加密结果响应给客户端</li>
</ul>
<p><em>注：magic string为：258EAFA5-E914-47DA-95CA-C5AB0DC85B11</em></p>
<h6 id="提取sec-websocket-key值并加密"><a class="markdownIt-Anchor" href="#提取sec-websocket-key值并加密"></a> 提取Sec-WebSocket-Key值并加密：</h6>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_headers</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    将请求头格式化成字典</span></span><br><span class="line"><span class="string">    :param data:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    header_dict = &#123;&#125;</span><br><span class="line">    data = str(data, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data.split(<span class="string">'\r\n'</span>):</span><br><span class="line">        print(i)</span><br><span class="line">    header, body = data.split(<span class="string">'\r\n\r\n'</span>, <span class="number">1</span>)</span><br><span class="line">    header_list = header.split(<span class="string">'\r\n'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(header_list)):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> len(header_list[i].split(<span class="string">' '</span>)) == <span class="number">3</span>:</span><br><span class="line">                header_dict[<span class="string">'method'</span>], header_dict[<span class="string">'url'</span>], header_dict[<span class="string">'protocol'</span>] = header_list[i].split(<span class="string">' '</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            k, v = header_list[i].split(<span class="string">':'</span>, <span class="number">1</span>)</span><br><span class="line">            header_dict[k] = v.strip()</span><br><span class="line">    <span class="keyword">return</span> header_dict</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">sock.bind((<span class="string">'127.0.0.1'</span>, <span class="number">8002</span>))</span><br><span class="line">sock.listen(<span class="number">5</span>)</span><br><span class="line"> </span><br><span class="line">conn, address = sock.accept()</span><br><span class="line">data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">headers = get_headers(data) <span class="comment"># 提取请求头信息</span></span><br><span class="line"><span class="comment"># 对请求头中的sec-websocket-key进行加密</span></span><br><span class="line">response_tpl = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span> \</span><br><span class="line">      <span class="string">"Upgrade:websocket\r\n"</span> \</span><br><span class="line">      <span class="string">"Connection: Upgrade\r\n"</span> \</span><br><span class="line">      <span class="string">"Sec-WebSocket-Accept: %s\r\n"</span> \</span><br><span class="line">      <span class="string">"WebSocket-Location: ws://%s%s\r\n\r\n"</span></span><br><span class="line">magic_string = <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span></span><br><span class="line">value = headers[<span class="string">'Sec-WebSocket-Key'</span>] + magic_string</span><br><span class="line">ac = base64.b64encode(hashlib.sha1(value.encode(<span class="string">'utf-8'</span>)).digest())</span><br><span class="line">response_str = response_tpl % (ac.decode(<span class="string">'utf-8'</span>), headers[<span class="string">'Host'</span>], headers[<span class="string">'url'</span>])</span><br><span class="line"><span class="comment"># 响应【握手】信息</span></span><br><span class="line">conn.send(bytes(response_str, encoding=<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>
<p>只有在服务端又发回&quot;响应&quot;的握手信息后，才算建立了链接。握手的作用是<strong>保证通信双方使用的协议相同</strong></p>
<h5 id="4客户端和服务端收发数据"><a class="markdownIt-Anchor" href="#4客户端和服务端收发数据"></a> 4.客户端和服务端收发数据</h5>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">数据报内容，第一行为字节，第二行为相应的每一位。</span><br><span class="line">0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len == 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>官网给出的解析规则</p>
<blockquote>
<p>The MASK bit simply tells whether the message is encoded. Messages from the client must be masked, so your server should expect this to be 1. (In fact, <a href="http://tools.ietf.org/html/rfc6455#section-5.1" target="_blank" rel="noopener">section 5.1 of the spec</a> says that your server must disconnect from a client if that client sends an unmasked message.) When sending a frame back to the client, do not mask it and do not set the mask bit. We’ll explain masking later. *Note: You have to mask messages even when using a secure socket.*RSV1-3 can be ignored, they are for extensions.</p>
<p>The opcode field defines how to interpret the payload data: 0x0 for continuation, <code>0x1</code> for text (which is always encoded in UTF-8), <code>0x2</code> for binary, and other so-called “control codes” that will be discussed later. In this version of WebSockets, <code>0x3</code> to <code>0x7</code> and <code>0xB</code> to <code>0xF</code> have no meaning.</p>
<p>The FIN bit tells whether this is the last message in a series. If it’s 0, then the server will keep listening for more parts of the message; otherwise, the server should consider the message delivered. More on this later.</p>
<p><strong>Decoding Payload Length</strong></p>
<p>To read the payload data, you must know when to stop reading. That’s why the payload length is important to know. Unfortunately, this is somewhat complicated. To read it, follow these steps:</p>
<ol>
<li>Read bits 9-15 (inclusive) and interpret that as an unsigned integer. If it’s 125 or less, then that’s the length; you’re <strong>done</strong>. If it’s 126, go to step 2. If it’s 127, go to step 3.</li>
<li>Read the next 16 bits and interpret those as an unsigned integer. You’re <strong>done</strong>.</li>
<li>Read the next 64 bits and interpret those as an unsigned integer (The most significant bit MUST be 0). You’re <strong>done</strong>.</li>
</ol>
<p><strong>Reading and Unmasking the Data</strong></p>
<p>If the MASK bit was set (and it should be, for client-to-server messages), read the next 4 octets (32 bits); this is the masking key. Once the payload length and masking key is decoded, you can go ahead and read that number of bytes from the socket. Let’s call the data <strong>ENCODED</strong>, and the key <strong>MASK</strong>. To get <strong>DECODED</strong>, loop through the octets (bytes a.k.a. characters for text data) of <strong>ENCODED</strong> and XOR the octet with the (i modulo 4)th octet of MASK. In pseudo-code (that happens to be valid JavaScript):</p>
<p>var DECODED = “”;<br>
for (var i = 0; i &lt; ENCODED.length; i++) {<br>
DECODED[i] = ENCODED[i] ^ MASK[i % 4];<br>
}</p>
<p>Now you can figure out what <strong>DECODED</strong> means depending on your application.</p>
</blockquote>
<h6 id="获取客户端发送的数据解包"><a class="markdownIt-Anchor" href="#获取客户端发送的数据解包"></a> 获取客户端发送的数据【解包】</h6>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analyze_info</span><span class="params">(info)</span>:</span></span><br><span class="line">    <span class="comment"># 处理数据头</span></span><br><span class="line">    <span class="comment"># mask占4个字节，在确定数据头的首部需要占多少字节后，再向后推4个字节</span></span><br><span class="line">    <span class="comment"># mask之后的就是数据的真正内容，但需要根据规则进行解析</span></span><br><span class="line">    payload_len = info[<span class="number">1</span>] &amp; <span class="number">127</span></span><br><span class="line">    <span class="keyword">if</span> payload_len == <span class="number">126</span>:</span><br><span class="line">        <span class="comment"># payload_len==126首部信息还要拓展2个字节(16 bits)</span></span><br><span class="line">        <span class="comment"># 见上文的 Decoding Payload Length-2</span></span><br><span class="line">        extend_payload_len = info[<span class="number">2</span>:<span class="number">4</span>]</span><br><span class="line">        mask = info[<span class="number">4</span>:<span class="number">8</span>]</span><br><span class="line">        decoded = info[<span class="number">8</span>:]</span><br><span class="line">    <span class="keyword">elif</span> payload_len == <span class="number">127</span>:</span><br><span class="line">        <span class="comment"># payload_len==127那么需要再拓展8个字节(64 bits)</span></span><br><span class="line">        <span class="comment"># 见上文的 Decoding Payload Length-3</span></span><br><span class="line">        extend_payload_len = info[<span class="number">2</span>:<span class="number">10</span>]</span><br><span class="line">        mask = info[<span class="number">10</span>:<span class="number">14</span>]</span><br><span class="line">        decoded = info[<span class="number">14</span>:]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        extend_payload_len = <span class="keyword">None</span></span><br><span class="line">        mask = info[<span class="number">2</span>:<span class="number">6</span>]</span><br><span class="line">        decoded = info[<span class="number">6</span>:]</span><br><span class="line">	<span class="string">'''</span></span><br><span class="line"><span class="string">	var DECODED = "";</span></span><br><span class="line"><span class="string">    for (var i = 0; i &lt; ENCODED.length; i++) &#123;</span></span><br><span class="line"><span class="string">        DECODED[i] = ENCODED[i] ^ MASK[i % 4];</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">	'''</span></span><br><span class="line">    bytes_list = bytearray()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(decoded)):</span><br><span class="line">        chunk = decoded[i] ^ mask[i % <span class="number">4</span>]</span><br><span class="line">        bytes_list.append(chunk)</span><br><span class="line">    content = str(bytes_list, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br></pre></td></tr></table></figure>
<h6 id="向客户端发送数据封包"><a class="markdownIt-Anchor" href="#向客户端发送数据封包"></a> 向客户端发送数据【封包】</h6>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_msg</span><span class="params">(conn, msg_bytes)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    WebSocket服务端向客户端发送消息</span></span><br><span class="line"><span class="string">    :param conn: 客户端连接到服务器端的socket对象,即： conn,address = socket.accept()</span></span><br><span class="line"><span class="string">    :param msg_bytes: 向客户端发送的字节</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">import</span> struct</span><br><span class="line"> </span><br><span class="line">    token = <span class="string">b"\x81"</span></span><br><span class="line">    length = len(msg_bytes)</span><br><span class="line">    <span class="keyword">if</span> length &lt; <span class="number">126</span>:</span><br><span class="line">        token += struct.pack(<span class="string">"B"</span>, length)</span><br><span class="line">    <span class="keyword">elif</span> length &lt;= <span class="number">0xFFFF</span>:</span><br><span class="line">        token += struct.pack(<span class="string">"!BH"</span>, <span class="number">126</span>, length)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        token += struct.pack(<span class="string">"!BQ"</span>, <span class="number">127</span>, length)</span><br><span class="line"> </span><br><span class="line">    msg = token + msg_bytes</span><br><span class="line">    conn.send(msg)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>转自<a href="https://home.cnblogs.com/u/wupeiqi/" target="_blank" rel="noopener">武沛齐</a>的<a href="https://www.cnblogs.com/wupeiqi/p/6558766.html" target="_blank" rel="noopener">你真的了解WebSocket吗？</a></p>
<h4 id="完整demo"><a class="markdownIt-Anchor" href="#完整demo"></a> 完整DEMO：</h4>
<h5 id="python服务端代码"><a class="markdownIt-Anchor" href="#python服务端代码"></a> Python服务端代码</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_headers</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    将请求头格式化成字典</span></span><br><span class="line"><span class="string">    :param data:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    header_dict = &#123;&#125;</span><br><span class="line">    data = str(data, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"> </span><br><span class="line">    header, body = data.split(<span class="string">'\r\n\r\n'</span>, <span class="number">1</span>)</span><br><span class="line">    header_list = header.split(<span class="string">'\r\n'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(header_list)):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> len(header_list[i].split(<span class="string">' '</span>)) == <span class="number">3</span>:</span><br><span class="line">                header_dict[<span class="string">'method'</span>], header_dict[<span class="string">'url'</span>], header_dict[<span class="string">'protocol'</span>] = header_list[i].split(<span class="string">' '</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            k, v = header_list[i].split(<span class="string">':'</span>, <span class="number">1</span>)</span><br><span class="line">            header_dict[k] = v.strip()</span><br><span class="line">    <span class="keyword">return</span> header_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_msg</span><span class="params">(conn, msg_bytes)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    WebSocket服务端向客户端发送消息</span></span><br><span class="line"><span class="string">    :param conn: 客户端连接到服务器端的socket对象,即： conn,address = socket.accept()</span></span><br><span class="line"><span class="string">    :param msg_bytes: 向客户端发送的字节</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">import</span> struct</span><br><span class="line"> </span><br><span class="line">    token = <span class="string">b"\x81"</span></span><br><span class="line">    length = len(msg_bytes)</span><br><span class="line">    <span class="keyword">if</span> length &lt; <span class="number">126</span>:</span><br><span class="line">        token += struct.pack(<span class="string">"B"</span>, length)</span><br><span class="line">    <span class="keyword">elif</span> length &lt;= <span class="number">0xFFFF</span>:</span><br><span class="line">        token += struct.pack(<span class="string">"!BH"</span>, <span class="number">126</span>, length)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        token += struct.pack(<span class="string">"!BQ"</span>, <span class="number">127</span>, length)</span><br><span class="line"> </span><br><span class="line">    msg = token + msg_bytes</span><br><span class="line">    conn.send(msg)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_socket</span><span class="params">()</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    sock.bind((<span class="string">'127.0.0.1'</span>, <span class="number">8003</span>))</span><br><span class="line">    sock.listen(<span class="number">5</span>)</span><br><span class="line"> </span><br><span class="line">    conn, address = sock.accept()</span><br><span class="line">    data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    headers = get_headers(data)</span><br><span class="line">    response_tpl = <span class="string">"HTTP/1.1 101 Switching Protocols\r\n"</span> \</span><br><span class="line">                   <span class="string">"Upgrade:websocket\r\n"</span> \</span><br><span class="line">                   <span class="string">"Connection:Upgrade\r\n"</span> \</span><br><span class="line">                   <span class="string">"Sec-WebSocket-Accept:%s\r\n"</span> \</span><br><span class="line">                   <span class="string">"WebSocket-Location:ws://%s%s\r\n\r\n"</span></span><br><span class="line"> </span><br><span class="line">    value = headers[<span class="string">'Sec-WebSocket-Key'</span>] + <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span></span><br><span class="line">    ac = base64.b64encode(hashlib.sha1(value.encode(<span class="string">'utf-8'</span>)).digest())</span><br><span class="line">    response_str = response_tpl % (ac.decode(<span class="string">'utf-8'</span>), headers[<span class="string">'Host'</span>], headers[<span class="string">'url'</span>])</span><br><span class="line">    conn.send(bytes(response_str, encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">    <span class="keyword">return</span> conn, sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analyze_info</span><span class="params">(info)</span>:</span></span><br><span class="line">    payload_len = info[<span class="number">1</span>] &amp; <span class="number">127</span></span><br><span class="line">    <span class="keyword">if</span> payload_len == <span class="number">126</span>:</span><br><span class="line">        extend_payload_len = info[<span class="number">2</span>:<span class="number">4</span>]</span><br><span class="line">        mask = info[<span class="number">4</span>:<span class="number">8</span>]</span><br><span class="line">        decoded = info[<span class="number">8</span>:]</span><br><span class="line">    <span class="keyword">elif</span> payload_len == <span class="number">127</span>:</span><br><span class="line">        extend_payload_len = info[<span class="number">2</span>:<span class="number">10</span>]</span><br><span class="line">        mask = info[<span class="number">10</span>:<span class="number">14</span>]</span><br><span class="line">        decoded = info[<span class="number">14</span>:]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        extend_payload_len = <span class="keyword">None</span></span><br><span class="line">        mask = info[<span class="number">2</span>:<span class="number">6</span>]</span><br><span class="line">        decoded = info[<span class="number">6</span>:]</span><br><span class="line"></span><br><span class="line">    bytes_list = bytearray()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(decoded)):</span><br><span class="line">        chunk = decoded[i] ^ mask[i % <span class="number">4</span>]</span><br><span class="line">        bytes_list.append(chunk)</span><br><span class="line">    content = str(bytes_list, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    conn, sock = init_socket()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            info = conn.recv(<span class="number">8096</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            info = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> info:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        content = analyze_info(info)</span><br><span class="line">        send_msg(conn, content.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>
<h5 id="html的客户端代码"><a class="markdownIt-Anchor" href="#html的客户端代码"></a> html的客户端代码</h5>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"txt"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btn"</span> <span class="attr">value</span>=<span class="string">"提交"</span> <span class="attr">onclick</span>=<span class="string">"sendMsg();"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"close"</span> <span class="attr">value</span>=<span class="string">"关闭连接"</span> <span class="attr">onclick</span>=<span class="string">"closeConn();"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">     </span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">"ws://127.0.0.1:8003/chatsocket"</span>);</span></span><br><span class="line"><span class="undefined">         </span></span><br><span class="line"><span class="actionscript">            socket.onopen = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">/* 与服务器端连接成功后，自动执行 */</span></span></span><br><span class="line"><span class="undefined">         </span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> newTag = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span></span><br><span class="line"><span class="actionscript">                newTag.innerHTML = <span class="string">"【连接成功】"</span>;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.getElementById(<span class="string">'content'</span>).appendChild(newTag);</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">         </span></span><br><span class="line"><span class="actionscript">            socket.onmessage = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">/* 服务器端向客户端发送数据时，自动执行 */</span></span></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> response = event.data;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> newTag = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span></span><br><span class="line"><span class="undefined">                newTag.innerHTML = response;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.getElementById(<span class="string">'content'</span>).appendChild(newTag);</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">         </span></span><br><span class="line"><span class="actionscript">            socket.onclose = <span class="function"><span class="keyword">function</span> <span class="params">(event)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="comment">/* 服务器端主动断开连接时，自动执行 */</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> newTag = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span></span><br><span class="line"><span class="actionscript">                newTag.innerHTML = <span class="string">"【关闭连接】"</span>;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.getElementById(<span class="string">'content'</span>).appendChild(newTag);</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="undefined">         </span></span><br><span class="line"><span class="actionscript">            <span class="function"><span class="keyword">function</span> <span class="title">sendMsg</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> txt = <span class="built_in">document</span>.getElementById(<span class="string">'txt'</span>);</span></span><br><span class="line"><span class="undefined">                socket.send(txt.value);</span></span><br><span class="line"><span class="actionscript">                txt.value = <span class="string">""</span>;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="actionscript">            <span class="function"><span class="keyword">function</span> <span class="title">closeConn</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="undefined">                socket.close();</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> newTag = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span></span><br><span class="line"><span class="actionscript">                newTag.innerHTML = <span class="string">"【关闭连接】"</span>;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.getElementById(<span class="string">'content'</span>).appendChild(newTag);</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">         </span></span><br><span class="line"><span class="undefined">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="tornado初探"><a class="markdownIt-Anchor" href="#tornado初探"></a> tornado初探</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ws = websocket.WebSocketApp(<span class="string">"ws://echo.websocket.org/"</span>,</span><br><span class="line">    on_message = on_message,</span><br><span class="line">    on_error = on_error,</span><br><span class="line">    on_close = on_close)</span><br><span class="line">ws.on_open = on_open</span><br><span class="line">ws.run_forever()</span><br></pre></td></tr></table></figure>
<p><strong>长连接，参数介绍：</strong></p>
<p>（1）url: websocket的地址。</p>
<p>（2）header: 客户发送websocket握手请求的请求头，{‘head1:value1’,‘head2:value2’}。</p>
<p>（3）on_open：在建立Websocket握手时调用的可调用对象，这个方法只有一个参数，就是该类本身。</p>
<p>（4）on_message：这个对象在接收到服务器返回的消息时调用。有两个参数，一个是该类本身，一个是我们从服务器获取的字符串（utf-8格式）。</p>
<p>（5）on_error：这个对象在遇到错误时调用，有两个参数，第一个是该类本身，第二个是异常对象。</p>
<p>（6）on_close：在遇到连接关闭的情况时调用，参数只有一个，就是该类本身。</p>
<p>（7）on_cont_message：这个对象在接收到连续帧数据时被调用，有三个参数，分别是：类本身，从服务器接受的字符串（utf-8），连续标志。</p>
<p>（8）on_data：当从服务器接收到消息时被调用，有四个参数，分别是：该类本身，接收到的字符串（utf-8），数据类型，连续标志。</p>
<p>（9）keep_running：一个二进制的标志位，如果为True，这个app的主循环将持续运行，默认值为True。</p>
<p>（10）get_mask_key：用于产生一个掩码。</p>
<p>（11）subprotocols：一组可用的子协议，默认为空。</p>
<h4 id="tornadohello_world"><a class="markdownIt-Anchor" href="#tornadohello_world"></a> tornado.hello_world</h4>
<ul>
<li><strong>Http</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexHandler</span><span class="params">(RequestHandler)</span>:</span></span><br><span class="line">    <span class="comment"># 正常1，抛错1、5</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_default_headers</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"调用了set_default_headers()"</span> </span><br><span class="line">	<span class="comment"># 正常2，抛错2</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"调用了initialize()"</span></span><br><span class="line"> 	<span class="comment"># 正常3，抛错3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"调用了prepare()"</span></span><br><span class="line"> 	<span class="comment"># 正常4，抛错4</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"调用了get()"</span></span><br><span class="line"> 	<span class="comment"># 正常4，抛错4</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"调用了post()"</span></span><br><span class="line">        self.send_error(<span class="number">200</span>)  <span class="comment"># 注意此出抛出了错误</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 正常无、抛错6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_error</span><span class="params">(self, status_code, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"调用了write_error()"</span>    </span><br><span class="line">        </span><br><span class="line"> 	<span class="comment"># 正常5、抛错7</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_finish</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"调用了on_finish()"</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 定义Http处理类型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="comment"># 处理路由参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self, subject)</span>:</span></span><br><span class="line">        self.subject = subject</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加一个处理get请求方式的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># write方法是写到缓冲区的</span></span><br><span class="line">        self.write(<span class="string">"Hello, world"</span>)</span><br><span class="line">        <span class="comment"># write会自动检测json类型，进行包装，并设Content-Type设置为application/json; charset=UTF-8。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_app</span><span class="params">()</span>:</span></span><br><span class="line">    settings = &#123;</span><br><span class="line">        <span class="string">'template_path'</span>: <span class="string">'templates'</span>,</span><br><span class="line">        <span class="string">'static_path'</span>: <span class="string">'static'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tornado.web.Application([</span><br><span class="line">        (<span class="string">r"/main"</span>, MainHandler, &#123;<span class="string">"subject"</span>:<span class="string">"c++"</span>&#125;),	<span class="comment"># 指定路由信息,路由参数会传入initialize()中</span></span><br><span class="line">        (<span class="string">r"/"</span>, IndexHandler),</span><br><span class="line">    	], debug=<span class="keyword">True</span>, **settings)</span><br><span class="line">    	</span><br><span class="line">	<span class="comment"># debug=True时，有自动重启、提供追踪信息等功能</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app = make_app()  <span class="comment"># 创建一个应用对象,得返回Application对象</span></span><br><span class="line">    app.listen(<span class="number">8888</span>)  <span class="comment"># 设置端口</span></span><br><span class="line">    tornado.ioloop.IOLoop.current().start()  <span class="comment"># 启动web程序，开始监听端口的连接</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Websocket</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ▲继承的类为WebSocketHandler</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatHandler</span><span class="params">(tornado.websocket.WebSocketHandler)</span>:</span></span><br><span class="line">    <span class="comment"># 用户存储当前聊天室用户</span></span><br><span class="line">    waiters = set()</span><br><span class="line">    <span class="comment"># 用于存储历时消息</span></span><br><span class="line">    messages = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端连接成功时，自动执行</span></span><br><span class="line"><span class="string">        :return: </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ChatHandler.waiters.add(self)</span><br><span class="line">        uid = str(uuid.uuid4())</span><br><span class="line">        self.write_message(uid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> msg <span class="keyword">in</span> ChatHandler.messages:</span><br><span class="line">            content = self.render_string(<span class="string">'message.html'</span>, **msg)</span><br><span class="line">            self.write_message(content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(self, message)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端连发送消息时，自动执行</span></span><br><span class="line"><span class="string">        :param message: </span></span><br><span class="line"><span class="string">        :return: </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        msg = json.loads(message)</span><br><span class="line">        ChatHandler.messages.append(message)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> client <span class="keyword">in</span> ChatHandler.waiters:</span><br><span class="line">            content = client.render_string(<span class="string">'message.html'</span>, **msg)</span><br><span class="line">            client.write_message(content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端关闭连接时，，自动执行</span></span><br><span class="line"><span class="string">        :return: </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ChatHandler.waiters.remove(self)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    settings = &#123;</span><br><span class="line">        <span class="string">'template_path'</span>: <span class="string">'templates'</span>,</span><br><span class="line">        <span class="string">'static_path'</span>: <span class="string">'static'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    application = tornado.web.Application([</span><br><span class="line">        (<span class="string">r"/"</span>, IndexHandler),</span><br><span class="line">        (<span class="string">r"/chat"</span>, ChatHandler),</span><br><span class="line">    ], **settings)</span><br><span class="line">    application.listen(<span class="number">8888</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>
<h4 id="基于tornado聊天室"><a class="markdownIt-Anchor" href="#基于tornado聊天室"></a> <a href="https://www.cnblogs.com/ssyfj/p/9245150.html" target="_blank" rel="noopener">基于Tornado——聊天室</a></h4>
<p>项目结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">│   app.py</span><br><span class="line">│</span><br><span class="line">├───static</span><br><span class="line">│       jquery-2.1.4.min.js</span><br><span class="line">│</span><br><span class="line">└───templates</span><br><span class="line">        index.html</span><br><span class="line">        message.html</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">import</span> tornado.websocket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.render(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatHandler</span><span class="params">(tornado.websocket.WebSocketHandler)</span>:</span></span><br><span class="line">    <span class="comment"># 用户存储当前聊天室用户</span></span><br><span class="line">    waiters = set()</span><br><span class="line">    <span class="comment"># 用于存储历时消息</span></span><br><span class="line">    messages = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端连接成功时，自动执行</span></span><br><span class="line"><span class="string">        :return: </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ChatHandler.waiters.add(self)</span><br><span class="line">        uid = str(uuid.uuid4())</span><br><span class="line">        self.write_message(uid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> msg <span class="keyword">in</span> ChatHandler.messages:</span><br><span class="line">            content = self.render_string(<span class="string">'message.html'</span>, **msg)</span><br><span class="line">            self.write_message(content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(self, message)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端连发送消息时，自动执行</span></span><br><span class="line"><span class="string">        :param message: </span></span><br><span class="line"><span class="string">        :return: </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        msg = json.loads(message)</span><br><span class="line">        ChatHandler.messages.append(message)</span><br><span class="line">		</span><br><span class="line">        <span class="comment"># 向当前在线的每个用户发送最新的消息界面</span></span><br><span class="line">        <span class="keyword">for</span> client <span class="keyword">in</span> ChatHandler.waiters:</span><br><span class="line">            content = client.render_string(<span class="string">'message.html'</span>, **msg)</span><br><span class="line">            client.write_message(content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        客户端关闭连接时，，自动执行</span></span><br><span class="line"><span class="string">        :return: </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ChatHandler.waiters.remove(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    settings = &#123;</span><br><span class="line">        <span class="string">'template_path'</span>: <span class="string">'templates'</span>,</span><br><span class="line">        <span class="string">'static_path'</span>: <span class="string">'static'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    application = tornado.web.Application([</span><br><span class="line">        (<span class="string">r"/"</span>, IndexHandler),</span><br><span class="line">        (<span class="string">r"/chat"</span>, ChatHandler),</span><br><span class="line">    ], **settings)</span><br><span class="line">    application.listen(<span class="number">8888</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>
<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Python聊天室<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"txt"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btn"</span> <span class="attr">value</span>=<span class="string">"提交"</span> <span class="attr">onclick</span>=<span class="string">"sendMsg();"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"close"</span> <span class="attr">value</span>=<span class="string">"关闭连接"</span> <span class="attr">onclick</span>=<span class="string">"closeConn();"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span> <span class="attr">style</span>=<span class="string">"border: 1px solid #dddddd;margin: 20px;min-height: 500px;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/static/jquery-2.1.4.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">            wsUpdater.start();</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> wsUpdater = &#123;</span></span><br><span class="line"><span class="actionscript">            socket: <span class="literal">null</span>,</span></span><br><span class="line"><span class="actionscript">            uid: <span class="literal">null</span>,</span></span><br><span class="line"><span class="actionscript">            start: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> url = <span class="string">"ws://127.0.0.1:8888/chat"</span>;</span></span><br><span class="line"><span class="actionscript">                wsUpdater.socket = <span class="keyword">new</span> WebSocket(url);</span></span><br><span class="line"><span class="actionscript">                wsUpdater.socket.onmessage = <span class="function"><span class="keyword">function</span><span class="params">(event)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(event);</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">if</span>(wsUpdater.uid)&#123;</span></span><br><span class="line"><span class="undefined">                        wsUpdater.showMessage(event.data);</span></span><br><span class="line"><span class="actionscript">                    &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="undefined">                        wsUpdater.uid = event.data;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            &#125;,</span></span><br><span class="line"><span class="actionscript">            showMessage: <span class="function"><span class="keyword">function</span><span class="params">(content)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                $(<span class="string">'#container'</span>).append(content);</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 按下提交按钮后，客户端向服务端发送信息，服务端再将数据给message.html渲染</span></span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">sendMsg</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> msg = &#123;</span></span><br><span class="line"><span class="undefined">                uid: wsUpdater.uid,</span></span><br><span class="line"><span class="javascript">                message: $(<span class="string">"#txt"</span>).val()</span></span><br><span class="line"><span class="undefined">            &#125;;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(msg));</span></span><br><span class="line"><span class="javascript">            wsUpdater.socket.send(<span class="built_in">JSON</span>.stringify(msg));</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>message.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"border: 1px solid #dddddd;margin: 10px;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>游客&#123;&#123;uid&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"margin-left: 20px;"</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>▲  整个执行流程：</p>
<ol>
<li>按下提交后调用html.sendMsg–&gt;</li>
<li>数据message–&gt;在后自动调用on_message，会将message传给massage.html渲染，将渲染结果(<strong>字符串</strong>)返回给用户(write_message)–&gt;</li>
<li>客户端收到消息后自动执行html.on_message会调用html.showMessage，把content即<strong>字符串</strong>(event.data)用jquery追加显示index.html页面上<code>$('#container').append(content);</code></li>
</ol>
<h2 id="附录文献"><a class="markdownIt-Anchor" href="#附录文献"></a> 附录文献:</h2>
<h3 id="websocket获取实时数据的几种常见链接方式"><a class="markdownIt-Anchor" href="#websocket获取实时数据的几种常见链接方式"></a> <a href="https://blog.csdn.net/Darkman_EX/article/details/82592118?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">websocket获取实时数据的几种常见链接方式</a></h3>
<h3 id="python使用websocket的几种方式"><a class="markdownIt-Anchor" href="#python使用websocket的几种方式"></a> <a href="https://jingniao.github.io/2016/04/10/python-websocket/?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">python使用websocket的几种方式</a></h3>
<h3 id="python-web-框架tornado初探"><a class="markdownIt-Anchor" href="#python-web-框架tornado初探"></a> <a href="https://blog.csdn.net/xc_zhou/article/details/80637714" target="_blank" rel="noopener">Python Web 框架：Tornado初探</a></h3>
<h3 id="python学习笔记tornado深入"><a class="markdownIt-Anchor" href="#python学习笔记tornado深入"></a> <a href="https://blog.csdn.net/tichimi3375/article/details/82109679" target="_blank" rel="noopener">▲Python学习笔记——Tornado深入</a></h3>
<h3 id="完整的websocket使用聊天室"><a class="markdownIt-Anchor" href="#完整的websocket使用聊天室"></a> <a href="https://www.cnblogs.com/ssyfj/p/9245150.html" target="_blank" rel="noopener">完整的websocket使用——聊天室</a></h3>
<h2 id="坑点记录"><a class="markdownIt-Anchor" href="#坑点记录"></a> 坑点记录：</h2>
<h3 id="1create_connection导入失败"><a class="markdownIt-Anchor" href="#1create_connection导入失败"></a> 1.create_connection导入失败</h3>
<p>Q:<code>ImportError: cannot import name 'create_connection' from 'websocket' (unknown location)</code></p>
<ul>
<li>A:在使用create_connection之前要安装<code>websocket_client</code> ,即 <code>pip install websocket-client</code></li>
</ul>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="https://nymrli.top">Mrli</a></p><p> <span>Link:  </span><a href="https://nymrli.top/2019/11/24/Python网络编程Websocket/">https://nymrli.top/2019/11/24/Python网络编程Websocket/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2019/11/26/MinMax和Alpha-beta剪枝分析-转/" title="MinMax和Alpha-beta剪枝分析[转]"><span>< PreviousPost</span><br><span class="prevTitle">MinMax和Alpha-beta剪枝分析[转]</span></a><a class="nextSlogan" href="/2019/11/17/第二十八届“和巨耀通杯”NOJ邀请赛/" title="第二十八届“和巨耀通杯”南京邮电大学在线测评系统程序设计邀请赛--"><span>NextPost ></span><br><span class="nextTitle">第二十八届“和巨耀通杯”南京邮电大学在线测评系统程序设计邀请赛--</span></a><div class="clear"></div></div><div id="comment"><div id="container"></div><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
  id: 'Python网络编程Websocket',
  owner: 'Freedomisgood',
  repo: 'Freedomisgood.github.io',
  oauth: {
    client_id: 'bc5a81fe36017dcd8b63',
    client_secret: '949cec3a1b91742c6249c47259791e4b80a6fa69',
  },
})
gitment.render('container')</script></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 60vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#网络知识websocket"><span class="toc-number">1.</span> <span class="toc-text"> 网络知识——Websocket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是webscoket"><span class="toc-number">1.0.1.</span> <span class="toc-text"> 什么是webscoket？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解析websocket协议"><span class="toc-number">1.0.2.</span> <span class="toc-text"> 解析websocket协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一步一步分析请求过程"><span class="toc-number">1.0.2.1.</span> <span class="toc-text"> 一步一步分析请求过程！！</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-启动服务端"><span class="toc-number">1.0.2.1.1.</span> <span class="toc-text"> 1. 启动服务端</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-客户端连接"><span class="toc-number">1.0.2.1.2.</span> <span class="toc-text"> 2. 客户端连接</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-建立连接握手"><span class="toc-number">1.0.2.1.3.</span> <span class="toc-text"> 3. 建立连接【握手】</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#获取请求信息"><span class="toc-number">1.0.2.1.3.1.</span> <span class="toc-text"> 获取请求信息</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#提取sec-websocket-key值并加密"><span class="toc-number">1.0.2.1.3.2.</span> <span class="toc-text"> 提取Sec-WebSocket-Key值并加密：</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4客户端和服务端收发数据"><span class="toc-number">1.0.2.1.4.</span> <span class="toc-text"> 4.客户端和服务端收发数据</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#获取客户端发送的数据解包"><span class="toc-number">1.0.2.1.4.1.</span> <span class="toc-text"> 获取客户端发送的数据【解包】</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#向客户端发送数据封包"><span class="toc-number">1.0.2.1.4.2.</span> <span class="toc-text"> 向客户端发送数据【封包】</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#完整demo"><span class="toc-number">1.0.2.2.</span> <span class="toc-text"> 完整DEMO：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#python服务端代码"><span class="toc-number">1.0.2.2.1.</span> <span class="toc-text"> Python服务端代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#html的客户端代码"><span class="toc-number">1.0.2.2.2.</span> <span class="toc-text"> html的客户端代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tornado初探"><span class="toc-number">1.0.3.</span> <span class="toc-text"> tornado初探</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tornadohello_world"><span class="toc-number">1.0.3.1.</span> <span class="toc-text"> tornado.hello_world</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于tornado聊天室"><span class="toc-number">1.0.3.2.</span> <span class="toc-text"> 基于Tornado——聊天室</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附录文献"><span class="toc-number">1.1.</span> <span class="toc-text"> 附录文献:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#websocket获取实时数据的几种常见链接方式"><span class="toc-number">1.1.1.</span> <span class="toc-text"> websocket获取实时数据的几种常见链接方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python使用websocket的几种方式"><span class="toc-number">1.1.2.</span> <span class="toc-text"> python使用websocket的几种方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python-web-框架tornado初探"><span class="toc-number">1.1.3.</span> <span class="toc-text"> Python Web 框架：Tornado初探</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python学习笔记tornado深入"><span class="toc-number">1.1.4.</span> <span class="toc-text"> ▲Python学习笔记——Tornado深入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#完整的websocket使用聊天室"><span class="toc-number">1.1.5.</span> <span class="toc-text"> 完整的websocket使用——聊天室</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#坑点记录"><span class="toc-number">1.2.</span> <span class="toc-text"> 坑点记录：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1create_connection导入失败"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 1.create_connection导入失败</span></a></li></ol></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>